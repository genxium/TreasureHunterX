{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","ALL_BATTLE_STATES","WAITING","IN_BATTLE","IN_SETTLEMENT","IN_DISMISSAL","MAGIC_ROOM_DOWNSYNC_FRAME_ID","BATTLE_READY_TO_START","PLAYER_ADDED","PLAYER_READDED","cc","Class","extends","Component","properties","useDiffFrameAlgo","default","canvasNode","type","Node","tiledAnimPrefab","Prefab","player1Prefab","player2Prefab","pumpkinPrefab","treasurePrefab","trapPrefab","acceleratorPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","simplePressToGoDialogPrefab","boundRoomIdLabel","Label","countdownLabel","trapBulletPrefab","resultPanelPrefab","gameRulePrefab","findingPlayerPrefab","countdownToBeginGamePrefab","playersInfoPrefab","guardTowerPrefab","forceBigEndianFloatingNumDecoding","_generateNewFullFrame","refFullFrame","diffFrame","newFullFrame","id","treasures","traps","bullets","players","speedShoes","pumpkin","guardTowers","playersLocalIdStrList","Object","keys","i","length","k","playerId","parseInt","removed","pumpkinsLocalIdStrList","pumpkinLocalIdInBattle","treasuresLocalIdStrList","treasureLocalIdInBattle","speedShoesLocalIdStrList","speedShoesLocalIdInBattle","trapsLocalIdStrList","trapLocalIdInBattle","bulletsLocalIdStrList","bulletLocalIdInBattle","console","log","accs","accsLocalIdStrList","accLocalIdInBattle","_dumpToFullFrameCache","fullFrame","self","recentFrameCacheCurrentSize","recentFrameCacheMaxCount","toDelFrameId","recentFrameCache","_onPerUpsyncFrame","instance","ackingFrameId","resyncing","lastRoomDownsyncFrameId","selfPlayerInfo","selfPlayerScriptIns","scheduledDirection","upsyncFrameData","dir","dx","parseFloat","dy","x","selfPlayerNode","y","wrapped","msgId","Date","now","act","data","sendSafely","JSON","stringify","onEnable","warn","mapIns","counter","onDisable","onDestroy","battleState","clearBoundRoomIdInBothVolatileAndPersistentStorage","handleRoomDownsyncFrame","handleClientSessionCloseOrError","upsyncLoopInterval","clearInterval","inputControlTimer","testOnlyResyncInterval","_lazilyTriggerResync","lastResyncingStartedAt","state","resyncingHintPopup","popupSimplePressToGo","t","_onResyncCompleted","resyncingDurationMillis","parent","removeChild","transitToState","labelString","hideYesButton","simplePressToGoDialogNode","instantiate","setPosition","v2","setScale","scale","simplePressToGoDialogScriptIns","getComponent","yesButton","getChildByName","postDismissalByYes","string","once","dismissDialog","bind","active","safelyAddChild","widgetsAboveAllNode","setLocalZOrder","alertForGoingBackToLoginScene","shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage","millisToGo","js","formatStr","setTimeout","logout","_resetCurrentMatch","mapNode","node","playersNode","Animation","play","start","otherPlayerNodeDict","treasureNodeDict","trapBulletNodeDict","trapNodeDict","pumpkinNodeDict","acceleratorNodeDict","mainCameraNode","mainCamera","Camera","children","child","zoomRatio","pumpkinInfoDict","otherPlayerCachedDataDict","treasureInfoDict","trapInfoDict","trapBulletInfoDict","towerNodeDict","findingPlayerNode","findingPlayerScriptIns","showPopupInCanvas","gameRuleNode","playersInfoNode","clearLocalStorageAndBackToLoginScene","musicEffectManagerScriptIns","stopAllMusic","closeWSConnection","clearSelfPlayer","sys","platform","WECHAT_GAME","director","loadScene","onLoad","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","confirmLogoutNode","resultPanelNode","width","height","resultPanelScriptIns","mapScriptIns","onAgainClicked","initPersistentSessionClient","initAfterWSConnected","gameRuleScriptIns","countdownToBeginGameNode","player1Node","player2Node","assign","clientUpsyncFps","tiledMapIns","TiledMap","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","posInMapNode","sizeInMapNode","origSize","setAnchorPoint","addClip","animationClip","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","sheltersZReducer","newShelter","newShelterColliderIns","hideGameRuleNode","parse","localStorage","getItem","_inputControlEnabled","setupInputControls","cachedPlayerMetas","refFrameId","playersMatched","playerMetas","hideExitButton","initWxSdk","updatePlayersInfo","frameId","isInitiatingFrame","cachedFullFrame","missingRequiredRefFrameCache","countdownNanos","countdownSeconds","isNaN","roomDownsyncFrame","onBattleStopped","sentAt","playerIdStrList","immediateSelfPlayerInfo","immediateSelfPlayerMeta","displayName","name","speed","score","joinIndex","anotherPlayer","pumpkinInfo","treasureInfo","acceleratorInfoDict","accelartors","accLocalIdStrList","accInfo","trapInfo","bulletInfo","guardTowerInfoDict","ids","localIdInBattle","tower","onBattleStarted","expectedRoomId","getExpectedRoomIdSync","disableGameRuleNode","modeButton","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","ctrl","setInterval","activeDirection","enableInputControls","disableInputControls","playBGM","spawnSelfPlayer","showPlayerInfo","clearInfo","newPlayerNode","toStartWithPos","showArrowTipNode","update","dt","canvasParentNode","boundRoomId","playersScriptIns","updateData","updateSpeed","toRemoveAcceleratorNodeDict","toRemovePlayerNodeDict","toRemoveTreasureNodeDict","toRemoveTrapNodeDict","toRemovePumpkinNodeDict","toRemoveBulletNodeDict","cachedPlayerData","newPos","targetNode","aControlledOtherPlayerScriptIns","oldPos","toMoveByVec","toMoveByVecMag","mag","toTeleportDisThreshold","notToMoveDisThreshold","normalizedDir","newScheduledDirection","discretizeDirection","joyStickEps","scheduleNewDirection","acceleratorInfo","towerInfo","rotation","remove","startAtPoint","endAtPoint","error","radian","Math","PI","abs","atan","angleTemp","angle","aBulletScriptIns","linearSpeed","aPumpkinScriptIns","treasureNodeScriptIns","setData","getNumberOfRunningActions","durationSeconds","runAction","moveTo","treasureScriptIns","playPickedUpAnimAndDestroy","playHighScoreTreasurePicked","playTreasurePicked","playCrashedByTrapBullet","err","s","byClick","localClearance","selfPlayerStr","selfPlayer","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","constants","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","success","res","ret","RET_CODE","OK","xhr","status","errMsg","timeout","e","onLogoutClicked","evt","onLogoutConfirmationDismissed","onGameRule1v1ModeClicked","cb","toShowNode","playerMeta","playersInfoScriptIns","countDownScriptIns"],"mappings":"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","file":"Map.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["const i18n = require('LanguageData');\r\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\r\n\r\nwindow.ALL_MAP_STATES = {\r\n  VISUAL: 0, // For free dragging & zooming.\r\n  EDITING_BELONGING: 1,\r\n  SHOWING_MODAL_POPUP: 2,\r\n};\r\n\r\nwindow.ALL_BATTLE_STATES = {\r\n  WAITING: 0,\r\n  IN_BATTLE: 1,\r\n  IN_SETTLEMENT: 2,\r\n  IN_DISMISSAL: 3,\r\n};\r\n\r\nwindow.MAGIC_ROOM_DOWNSYNC_FRAME_ID = {\r\n  BATTLE_READY_TO_START: -99,\r\n  PLAYER_ADDED: -98,\r\n  PLAYER_READDED: -97,\r\n};\r\n\r\ncc.Class({\r\n  extends: cc.Component,\r\n\r\n  properties: {\r\n    useDiffFrameAlgo: {\r\n      default: true\r\n    },\r\n    canvasNode: {\r\n      type: cc.Node,\r\n      default: null,\r\n    },\r\n    tiledAnimPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    player1Prefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    player2Prefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    pumpkinPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    treasurePrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    trapPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    acceleratorPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    barrierPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    shelterPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    shelterZReducerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    keyboardInputControllerNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    joystickInputControllerNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    confirmLogoutPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    simplePressToGoDialogPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    boundRoomIdLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    countdownLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    trapBulletPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    resultPanelPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    gameRulePrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    findingPlayerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    countdownToBeginGamePrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    playersInfoPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    guardTowerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    forceBigEndianFloatingNumDecoding: {\r\n      default: false,\r\n    },\r\n  },\r\n\r\n  _generateNewFullFrame: function(refFullFrame, diffFrame) {\r\n    let newFullFrame = {\r\n      id: diffFrame.id,\r\n      treasures: refFullFrame.treasures,\r\n      traps: refFullFrame.traps,\r\n      bullets: refFullFrame.bullets,\r\n      players: refFullFrame.players,\r\n      speedShoes: refFullFrame.speedShoes,\r\n      pumpkin: refFullFrame.pumpkin,\r\n      guardTowers: refFullFrame.guardTowers, //TODO: diffFrame\r\n    };\r\n    const players = diffFrame.players;\r\n    const playersLocalIdStrList = Object.keys(players);\r\n    for (let i = 0; i < playersLocalIdStrList.length; ++i) {\r\n      const k = playersLocalIdStrList[i];\r\n      const playerId = parseInt(k);\r\n      if (true == diffFrame.players[playerId].removed) {\r\n        delete newFullFrame.players[playerId];\r\n      } else {\r\n        newFullFrame.players[playerId] = diffFrame.players[playerId];\r\n      }\r\n    }\r\n\r\n    const pumpkin = diffFrame.pumpkin;\r\n    const pumpkinsLocalIdStrList = Object.keys(pumpkin);\r\n    for (let i = 0; i < pumpkinsLocalIdStrList.length; ++i) {\r\n      const k = pumpkinsLocalIdStrList[i];\r\n      const pumpkinLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.pumpkin[pumpkinLocalIdInBattle].removed) {\r\n        delete newFullFrame.pumpkin[pumpkinLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.pumpkin[pumpkinLocalIdInBattle] = diffFrame.pumpkin[pumpkinLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const treasures = diffFrame.treasures;\r\n    const treasuresLocalIdStrList = Object.keys(treasures);\r\n    for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\r\n      const k = treasuresLocalIdStrList[i];\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.treasures[treasureLocalIdInBattle].removed) {\r\n        delete newFullFrame.treasures[treasureLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.treasures[treasureLocalIdInBattle] = diffFrame.treasures[treasureLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const speedShoes = diffFrame.speedShoes;\r\n    const speedShoesLocalIdStrList = Object.keys(speedShoes);\r\n    for (let i = 0; i < speedShoesLocalIdStrList.length; ++i) {\r\n      const k = speedShoesLocalIdStrList[i];\r\n      const speedShoesLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.speedShoes[speedShoesLocalIdInBattle].removed) {\r\n        delete newFullFrame.speedShoes[speedShoesLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.speedShoes[speedShoesLocalIdInBattle] = diffFrame.speedShoes[speedShoesLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const traps = diffFrame.traps;\r\n    const trapsLocalIdStrList = Object.keys(traps);\r\n    for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\r\n      const k = trapsLocalIdStrList[i];\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.traps[trapLocalIdInBattle].removed) {\r\n        delete newFullFrame.traps[trapLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.traps[trapLocalIdInBattle] = diffFrame.traps[trapLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const bullets = diffFrame.bullets;\r\n    const bulletsLocalIdStrList = Object.keys(bullets);\r\n    for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\r\n      const k = bulletsLocalIdStrList[i];\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.bullets[bulletLocalIdInBattle].removed) {\r\n        console.log(\"Bullet with localIdInBattle == \", bulletLocalIdInBattle, \"is removed.\");\r\n        delete newFullFrame.bullets[bulletLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.bullets[bulletLocalIdInBattle] = diffFrame.bullets[bulletLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const accs = diffFrame.speedShoes;\r\n    const accsLocalIdStrList = Object.keys(accs);\r\n    for (let i = 0; i < accsLocalIdStrList.length; ++i) {\r\n      const k = accsLocalIdStrList[i];\r\n      const accLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.speedShoes[accLocalIdInBattle].removed) {\r\n        delete newFullFrame.speedShoes[accLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.speedShoes[accLocalIdInBattle] = diffFrame.speedShoes[accLocalIdInBattle];\r\n      }\r\n    }\r\n    return newFullFrame;\r\n  },\r\n\r\n  _dumpToFullFrameCache: function(fullFrame) {\r\n    const self = this;\r\n    while (self.recentFrameCacheCurrentSize >= self.recentFrameCacheMaxCount) {\r\n      // Trick here: never evict the \"Zero-th Frame\" for resyncing!\r\n      const toDelFrameId = Object.keys(self.recentFrameCache)[1];\r\n      delete self.recentFrameCache[toDelFrameId];\r\n      --self.recentFrameCacheCurrentSize;\r\n    }\r\n    self.recentFrameCache[fullFrame.id] = fullFrame;\r\n    ++self.recentFrameCacheCurrentSize;\r\n  },\r\n\r\n  _onPerUpsyncFrame() {\r\n    const instance = this;\r\n    const ackingFrameId = (instance.resyncing ? 0 : instance.lastRoomDownsyncFrameId);\r\n    if (\r\n      null == instance.selfPlayerInfo ||\r\n      null == instance.selfPlayerScriptIns ||\r\n      null == instance.selfPlayerScriptIns.scheduledDirection\r\n      ) return;\r\n    const upsyncFrameData = {\r\n      id: instance.selfPlayerInfo.id,\r\n      /**\r\n      * WARNING\r\n      *\r\n      * Deliberately NOT upsyncing the `instance.selfPlayerScriptIns.activeDirection` here, because it'll be deduced by other players from the position differences of `RoomDownsyncFrame`s.\r\n      */\r\n      dir: {\r\n        dx: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dx),\r\n        dy: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dy),\r\n      },\r\n      x: parseFloat(instance.selfPlayerNode.x),\r\n      y: parseFloat(instance.selfPlayerNode.y),\r\n      ackingFrameId: ackingFrameId,\r\n    };\r\n    const wrapped = {\r\n      msgId: Date.now(),\r\n      act: \"PlayerUpsyncCmd\",\r\n      data: upsyncFrameData,\r\n    }\r\n    window.sendSafely(JSON.stringify(wrapped));\r\n  },\r\n\r\n  onEnable() {\r\n    cc.warn(`+++++++ Map onEnable(), mapIns.counter: ${window.mapIns.counter}`);\r\n  },\r\n\r\n  onDisable() {\r\n    cc.warn(`+++++++ Map onDisable(), mapIns.counter: ${window.mapIns.counter}`);\r\n  },\r\n\r\n  onDestroy() {\r\n    const self = this;\r\n    cc.warn(`+++++++ Map onDestroy(), mapIns.counter: ${window.mapIns.counter}`);\r\n    if (null == self.battleState || ALL_BATTLE_STATES.WAITING == self.battleState) {\r\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n    }\r\n    if (null != window.handleRoomDownsyncFrame) {\r\n      window.handleRoomDownsyncFrame = null;\r\n    }\r\n    if (null != window.handleClientSessionCloseOrError) {\r\n      window.handleClientSessionCloseOrError = null;\r\n    }\r\n    if (self.upsyncLoopInterval) {\r\n      clearInterval(self.upsyncLoopInterval);\r\n    }\r\n    if (self.inputControlTimer) {\r\n      clearInterval(self.inputControlTimer);\r\n    }\r\n    if (self.testOnlyResyncInterval) {\r\n      clearInterval(self.testOnlyResyncInterval);\r\n    }\r\n  },\r\n\r\n  _lazilyTriggerResync() {\r\n    if (true == this.resyncing) return;\r\n    this.lastResyncingStartedAt = Date.now();\r\n    this.resyncing = true; // Will keep `this._onPerUpsyncFrame()` sending `ackingFrameId == 0` till the invocation of `this._onResyncCompleted()`. \r\n\r\n    console.warn(\"_lazilyTriggerResync, resyncing\");\r\n\r\n    if (ALL_MAP_STATES.SHOWING_MODAL_POPUP != this.state) {\r\n      if (null == this.resyncingHintPopup) {\r\n        this.resyncingHintPopup = this.popupSimplePressToGo(i18n.t(\"gameTip.resyncing\"), true);\r\n      }\r\n    }\r\n  },\r\n\r\n  _onResyncCompleted() {\r\n    if (false == this.resyncing) return;\r\n    this.resyncing = false;\r\n    const resyncingDurationMillis = (Date.now() - this.lastResyncingStartedAt);\r\n    console.warn(\"_onResyncCompleted, resyncing took \", resyncingDurationMillis, \" milliseconds.\");\r\n    if (null != this.resyncingHintPopup && this.resyncingHintPopup.parent) {\r\n      this.resyncingHintPopup.parent.removeChild(this.resyncingHintPopup);\r\n      if (ALL_MAP_STATES.SHOWING_MODAL_POPUP == this.state) {\r\n        this.transitToState(ALL_MAP_STATES.VISUAL);\r\n      }\r\n    }\r\n  },\r\n\r\n  popupSimplePressToGo(labelString, hideYesButton) {\r\n    const self = this;\r\n    self.state = ALL_MAP_STATES.SHOWING_MODAL_POPUP;\r\n\r\n    const canvasNode = self.canvasNode;\r\n    const simplePressToGoDialogNode = cc.instantiate(self.simplePressToGoDialogPrefab);\r\n    simplePressToGoDialogNode.setPosition(cc.v2(0, 0));\r\n    simplePressToGoDialogNode.setScale(1 / canvasNode.scale);\r\n    const simplePressToGoDialogScriptIns = simplePressToGoDialogNode.getComponent(\"SimplePressToGoDialog\");\r\n    const yesButton = simplePressToGoDialogNode.getChildByName(\"Yes\");\r\n    const postDismissalByYes = () => {\r\n      self.transitToState(ALL_MAP_STATES.VISUAL);\r\n      canvasNode.removeChild(simplePressToGoDialogNode);\r\n    }\r\n    simplePressToGoDialogNode.getChildByName(\"Hint\").getComponent(cc.Label).string = labelString;\r\n    yesButton.once(\"click\", simplePressToGoDialogScriptIns.dismissDialog.bind(simplePressToGoDialogScriptIns, postDismissalByYes));\r\n    yesButton.getChildByName(\"Label\").getComponent(cc.Label).string = \"OK\";\r\n\r\n    if (true == hideYesButton) {\r\n      yesButton.active = false;\r\n    }\r\n\r\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\r\n    safelyAddChild(self.widgetsAboveAllNode, simplePressToGoDialogNode);\r\n    setLocalZOrder(simplePressToGoDialogNode, 20);\r\n    return simplePressToGoDialogNode;\r\n  },\r\n\r\n  alertForGoingBackToLoginScene(labelString, mapIns, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    const millisToGo = 3000;\r\n    mapIns.popupSimplePressToGo(cc.js.formatStr(\"%s will logout in %s seconds.\", labelString, millisToGo / 1000));\r\n    setTimeout(() => {\r\n      mapIns.logout(false, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\r\n    }, millisToGo);\r\n  },\r\n\r\n  _resetCurrentMatch() {\r\n    const self = this;\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    self.countdownLabel.string = \"\";\r\n    if (self.playersNode) {\r\n      for (let i in self.playersNode) {\r\n        let node = self.playersNode[i];\r\n        node.getComponent(cc.Animation).play(\"Bottom\");\r\n        node.getComponent(\"SelfPlayer\").start();\r\n        node.active = true;\r\n      }\r\n    }\r\n    if (self.otherPlayerNodeDict) {\r\n      for (let i in self.otherPlayerNodeDict) {\r\n        let node = self.otherPlayerNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n    if (self.selfPlayerNode && self.selfPlayerNode.parent) {\r\n      self.selfPlayerNode.parent.removeChild(self.selfPlayerNode);\r\n    }\r\n    if (self.treasureNodeDict) {\r\n      for (let i in self.treasureNodeDict) {\r\n        let node = self.treasureNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n    if (self.trapBulletNodeDict) {\r\n      for (let i in self.trapBulletNodeDict) {\r\n        let node = self.trapBulletNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n    if (self.trapNodeDict) {\r\n      for (let i in self.trapNodeDict) {\r\n        let node = self.trapNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (self.pumpkinNodeDict) {\r\n      for (let i in self.pumpkinNodeDict) {\r\n        let node = self.pumpkinNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (self.acceleratorNodeDict) {\r\n      for (let i in self.acceleratorNodeDict) {\r\n        let node = self.acceleratorNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (self.upsyncLoopInterval) {\r\n      clearInterval(self.upsyncLoopInterval);\r\n    }\r\n\r\n    self.mainCameraNode = canvasNode.getChildByName(\"Main Camera\");\r\n    self.mainCamera = self.mainCameraNode.getComponent(cc.Camera);\r\n    for (let child of self.mainCameraNode.children) {\r\n      child.setScale(1 / self.mainCamera.zoomRatio);\r\n    }\r\n    self.widgetsAboveAllNode = self.mainCameraNode.getChildByName(\"WidgetsAboveAll\");\r\n    self.mainCameraNode.setPosition(cc.v2());\r\n\r\n    self.resyncing = false;\r\n    self.lastRoomDownsyncFrameId = 0;\r\n\r\n    self.recentFrameCache = {};\r\n    self.recentFrameCacheCurrentSize = 0;\r\n    self.recentFrameCacheMaxCount = 2048;\r\n    self.selfPlayerNode = null;\r\n    self.selfPlayerScriptIns = null;\r\n    self.selfPlayerInfo = null;\r\n    self.upsyncLoopInterval = null;\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n\r\n    self.battleState = ALL_BATTLE_STATES.WAITING;\r\n\r\n    self.pumpkinInfoDict = {};\r\n    self.pumpkinNodeDict = {};\r\n    self.otherPlayerCachedDataDict = {};\r\n    self.otherPlayerNodeDict = {};\r\n    self.treasureInfoDict = {};\r\n    self.treasureNodeDict = {};\r\n    self.trapInfoDict = {};\r\n    self.trapBulletInfoDict = {};\r\n    self.trapBulletNodeDict = {};\r\n    self.trapNodeDict = {};\r\n    self.towerNodeDict = {};\r\n    self.acceleratorNodeDict = {};\r\n    if (self.findingPlayerNode) {\r\n      const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n      findingPlayerScriptIns.init();\r\n    }\r\n    self.showPopupInCanvas(self.gameRuleNode);\r\n    safelyAddChild(self.widgetsAboveAllNode, self.playersInfoNode);\r\n  },\r\n\r\n  clearLocalStorageAndBackToLoginScene(shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    const self = this;\r\n    console.warn('+++++++ Calling `clearLocalStorageAndBackToLoginScene`, mapIns.counter:', self.counter);\r\n\r\n    if (self.musicEffectManagerScriptIns) {\r\n      self.musicEffectManagerScriptIns.stopAllMusic();\r\n    }\r\n    /**\r\n     * Here I deliberately removed the callback in the \"common `handleClientSessionCloseOrError` callback\"\r\n     * within which another invocation to `clearLocalStorageAndBackToLoginScene` will be made.\r\n     *\r\n     * It'll be re-assigned to the common one upon reentrance of `Map.onLoad`.\r\n     *\r\n     * -- YFLu 2019-04-06\r\n     */\r\n    window.handleClientSessionCloseOrError = () => {\r\n      console.warn('+++++++ Special handleClientSessionCloseOrError() assigned within `clearLocalStorageAndBackToLoginScene`, mapIns.counter:', window.mapIns.counter);\r\n      // TBD.\r\n      window.handleClientSessionCloseOrError = null; // To ensure that it's called at most once. \r\n    };\r\n    window.closeWSConnection();\r\n    window.clearSelfPlayer();\r\n    if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n    }\r\n    if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n      cc.director.loadScene('wechatGameLogin');\r\n    } else {\r\n      cc.director.loadScene('login');\r\n    }\r\n  },\r\n\r\n  onLoad() {\r\n    const self = this;\r\n    window.mapIns = self;\r\n    window.forceBigEndianFloatingNumDecoding = self.forceBigEndianFloatingNumDecoding;\r\n\r\n    self.counter = (() => {\r\n      if (window.mapIns == null || null == window.mapIns.counter) {\r\n        return 0;\r\n      } else {\r\n        return window.mapIns.counter + 1;\r\n      }\r\n    })();\r\n\r\n    cc.warn('+++++++ Map onLoad(), map counter:', window.mapIns.counter);\r\n    window.handleClientSessionCloseOrError = function() {\r\n      console.warn('+++++++ Common handleClientSessionCloseOrError(), mapIns.counter:', window.mapIns.counter);\r\n\r\n      if (ALL_BATTLE_STATES.IN_SETTLEMENT == self.battleState) { //\r\n        console.log(\", \");\r\n      } else {\r\n        console.warn(\"\");\r\n        self.clearLocalStorageAndBackToLoginScene(true);\r\n      }\r\n    };\r\n\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    cc.director.getCollisionManager().enabled = true;\r\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\r\n    self.musicEffectManagerScriptIns = self.node.getComponent(\"MusicEffectManager\");\r\n\r\n    /** Init required prefab started. */\r\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\r\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\r\n\r\n    // Initializes Result panel.\r\n    self.resultPanelNode = cc.instantiate(self.resultPanelPrefab);\r\n    self.resultPanelNode.width = self.canvasNode.width;\r\n    self.resultPanelNode.height = self.canvasNode.height;\r\n\r\n    const resultPanelScriptIns = self.resultPanelNode.getComponent(\"ResultPanel\");\r\n    resultPanelScriptIns.mapScriptIns = self;\r\n    resultPanelScriptIns.onAgainClicked = () => {\r\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n      self._resetCurrentMatch();\r\n      window.initPersistentSessionClient(self.initAfterWSConnected, null /* Deliberately NOT passing in any `expectedRoomId`. -- YFLu */ );\r\n    };\r\n\r\n    self.gameRuleNode = cc.instantiate(self.gameRulePrefab);\r\n    self.gameRuleNode.width = self.canvasNode.width;\r\n    self.gameRuleNode.height = self.canvasNode.height;\r\n\r\n    self.gameRuleScriptIns = self.gameRuleNode.getComponent(\"GameRule\");\r\n    self.gameRuleScriptIns.mapNode = self.node;\r\n\r\n    self.findingPlayerNode = cc.instantiate(self.findingPlayerPrefab);\r\n    self.findingPlayerNode.width = self.canvasNode.width;\r\n    self.findingPlayerNode.height = self.canvasNode.height;\r\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n    findingPlayerScriptIns.init();\r\n\r\n    self.playersInfoNode = cc.instantiate(self.playersInfoPrefab);\r\n\r\n    self.countdownToBeginGameNode = cc.instantiate(self.countdownToBeginGamePrefab);\r\n    self.countdownToBeginGameNode.width = self.canvasNode.width;\r\n    self.countdownToBeginGameNode.height = self.canvasNode.height;\r\n\r\n    self.playersNode = {};\r\n    const player1Node = cc.instantiate(self.player1Prefab);\r\n    const player2Node = cc.instantiate(self.player2Prefab);\r\n    Object.assign(self.playersNode, {\r\n      1: player1Node\r\n    });\r\n    Object.assign(self.playersNode, {\r\n      2: player2Node\r\n    });\r\n\r\n    /** Init required prefab ended. */\r\n\r\n    self.clientUpsyncFps = 20;\r\n    self._resetCurrentMatch();\r\n\r\n    const tiledMapIns = self.node.getComponent(cc.TiledMap);\r\n    const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node);\r\n    for (let frameAnim of boundaryObjs.frameAnimations) {\r\n      const animNode = cc.instantiate(self.tiledAnimPrefab);\r\n      const anim = animNode.getComponent(cc.Animation);\r\n      animNode.setPosition(frameAnim.posInMapNode);\r\n      animNode.width = frameAnim.sizeInMapNode.width;\r\n      animNode.height = frameAnim.sizeInMapNode.height;\r\n      animNode.setScale(frameAnim.sizeInMapNode.width / frameAnim.origSize.width, frameAnim.sizeInMapNode.height / frameAnim.origSize.height);\r\n      animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\r\n      safelyAddChild(self.node, animNode);\r\n      setLocalZOrder(animNode, 5);\r\n      anim.addClip(frameAnim.animationClip, \"default\");\r\n      anim.play(\"default\");\r\n    }\r\n\r\n    self.barrierColliders = [];\r\n    for (let boundaryObj of boundaryObjs.barriers) {\r\n      const newBarrier = cc.instantiate(self.barrierPrefab);\r\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\r\n      newBarrier.setPosition(newBoundaryOffsetInMapNode);\r\n      newBarrier.setAnchorPoint(cc.v2(0, 0));\r\n      const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider);\r\n      newBarrierColliderIns.points = [];\r\n      for (let p of boundaryObj) {\r\n        newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\r\n      }\r\n      self.barrierColliders.push(newBarrierColliderIns);\r\n      self.node.addChild(newBarrier);\r\n    }\r\n    const allLayers = tiledMapIns.getLayers();\r\n    for (let layer of allLayers) {\r\n      const layerType = layer.getProperty(\"type\");\r\n      switch (layerType) {\r\n        case \"normal\":\r\n          setLocalZOrder(layer.node, 0);\r\n          break;\r\n        case \"barrier_and_shelter\":\r\n          setLocalZOrder(layer.node, 3);\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n\r\n    const allObjectGroups = tiledMapIns.getObjectGroups();\r\n    for (let objectGroup of allObjectGroups) {\r\n      const objectGroupType = objectGroup.getProperty(\"type\");\r\n      switch (objectGroupType) {\r\n        case \"barrier_and_shelter\":\r\n          setLocalZOrder(objectGroup.node, 3);\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n\r\n    for (let boundaryObj of boundaryObjs.sheltersZReducer) {\r\n      const newShelter = cc.instantiate(self.shelterZReducerPrefab);\r\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\r\n      newShelter.setPosition(newBoundaryOffsetInMapNode);\r\n      newShelter.setAnchorPoint(cc.v2(0, 0));\r\n      const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider);\r\n      newShelterColliderIns.points = [];\r\n      for (let p of boundaryObj) {\r\n        newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\r\n      }\r\n      self.node.addChild(newShelter);\r\n    }\r\n\r\n    self.initAfterWSConnected = () => {\r\n      const self = window.mapIns;\r\n      self.hideGameRuleNode();\r\n      self.selfPlayerInfo = JSON.parse(cc.sys.localStorage.getItem('selfPlayer'));\r\n      Object.assign(self.selfPlayerInfo, {\r\n        id: self.selfPlayerInfo.playerId\r\n      });\r\n      self.transitToState(ALL_MAP_STATES.WAITING);\r\n      self._inputControlEnabled = false;\r\n      self.setupInputControls();\r\n\r\n      let cachedPlayerMetas = {};\r\n\r\n      window.handleRoomDownsyncFrame = function(diffFrame) {\r\n        if (ALL_BATTLE_STATES.WAITING != self.battleState\r\n          && ALL_BATTLE_STATES.IN_BATTLE != self.battleState\r\n          && ALL_BATTLE_STATES.IN_SETTLEMENT != self.battleState) {\r\n          return;\r\n        }\r\n        const refFrameId = diffFrame.refFrameId;\r\n        if (window.MAGIC_ROOM_DOWNSYNC_FRAME_ID.BATTLE_READY_TO_START == refFrameId) {\r\n          //\r\n          self.playersMatched(diffFrame.playerMetas);\r\n          cachedPlayerMetas = diffFrame.playerMetas;\r\n          //\r\n          const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n          findingPlayerScriptIns.hideExitButton();\r\n        } else if (window.MAGIC_ROOM_DOWNSYNC_FRAME_ID.PLAYER_ADDED == refFrameId) {\r\n          //\r\n          if (window.initWxSdk) {\r\n            window.initWxSdk();\r\n          }\r\n          const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n          if (!self.findingPlayerNode.parent) {\r\n            self.showPopupInCanvas(self.findingPlayerNode);\r\n          }\r\n          findingPlayerScriptIns.updatePlayersInfo(diffFrame.playerMetas);\r\n          cachedPlayerMetas = diffFrame.playerMetas;\r\n          return;\r\n        } else if (window.MAGIC_ROOM_DOWNSYNC_FRAME_ID.PLAYER_READDED == refFrameId) {\r\n          cachedPlayerMetas = diffFrame.playerMetas;\r\n          return;\r\n        } else {\r\n          // Deliberately left blank.\r\n        }\r\n\r\n        const frameId = diffFrame.id;\r\n        if (frameId <= self.lastRoomDownsyncFrameId) {\r\n          // Log the obsolete frames?\r\n          return;\r\n        }\r\n        const isInitiatingFrame = (0 >= self.recentFrameCacheCurrentSize || 0 == refFrameId);\r\n        const cachedFullFrame = self.recentFrameCache[refFrameId];\r\n\r\n        const missingRequiredRefFrameCache = (false == isInitiatingFrame\r\n          &&\r\n          (refFrameId > 0 || 0 < self.recentFrameCacheCurrentSize) // Critical condition to differentiate between \"BattleStarted\" or \"ShouldResync\".\r\n          &&\r\n          null == cachedFullFrame\r\n        );\r\n        if (self.useDiffFrameAlgo && missingRequiredRefFrameCache) {\r\n          self._lazilyTriggerResync();\r\n          return;\r\n        }\r\n\r\n        if (true == self.resyncing) {\r\n          if (isInitiatingFrame && 0 == refFrameId) {\r\n            // Reaching here implies that you've received the resync frame.\r\n            self._onResyncCompleted();\r\n          } else {\r\n            return;\r\n          }\r\n        }\r\n        let countdownNanos = diffFrame.countdownNanos;\r\n        if (countdownNanos < 0) {\r\n          countdownNanos = 0;\r\n        }\r\n        const countdownSeconds = parseInt(countdownNanos / 1000000000);\r\n        if (isNaN(countdownSeconds)) {\r\n          cc.warn(`countdownSeconds is NaN for countdownNanos == ${countdownNanos}.`);\r\n        }\r\n        self.countdownLabel.string = countdownSeconds;\r\n        const roomDownsyncFrame = (\r\n        (isInitiatingFrame || !self.useDiffFrameAlgo)\r\n          ?\r\n          diffFrame\r\n          :\r\n          self._generateNewFullFrame(cachedFullFrame, diffFrame)\r\n        );\r\n\r\n        if (countdownNanos <= 0) {\r\n          self.onBattleStopped(cachedPlayerMetas, roomDownsyncFrame.players);\r\n          return;\r\n        }\r\n        self._dumpToFullFrameCache(roomDownsyncFrame);\r\n        const sentAt = roomDownsyncFrame.sentAt;\r\n\r\n        const players = roomDownsyncFrame.players;\r\n        const playerIdStrList = Object.keys(players);\r\n        self.otherPlayerCachedDataDict = {};\r\n        for (let i = 0; i < playerIdStrList.length; ++i) {\r\n          const k = playerIdStrList[i];\r\n          const playerId = parseInt(k);\r\n          if (playerId == self.selfPlayerInfo.id) {\r\n            const immediateSelfPlayerInfo = players[k];\r\n            const immediateSelfPlayerMeta = cachedPlayerMetas[k];\r\n            Object.assign(self.selfPlayerInfo, {\r\n              displayName: (null == immediateSelfPlayerMeta.displayName ? (null == immediateSelfPlayerMeta.name ? \"\" : immediateSelfPlayerMeta.name) : immediateSelfPlayerMeta.displayName),\r\n              x: immediateSelfPlayerInfo.x,\r\n              y: immediateSelfPlayerInfo.y,\r\n              speed: immediateSelfPlayerInfo.speed,\r\n              battleState: immediateSelfPlayerInfo.battleState,\r\n              score: immediateSelfPlayerInfo.score,\r\n              joinIndex: immediateSelfPlayerInfo.joinIndex,\r\n            });\r\n            continue;\r\n          }\r\n          const anotherPlayer = players[k];\r\n          Object.assign(anotherPlayer, cachedPlayerMetas[k]);\r\n          // Note that this callback is invoked in the NetworkThread, and the rendering should be executed in the GUIThread, e.g. within `update(dt)`.\r\n          self.otherPlayerCachedDataDict[playerId] = anotherPlayer;\r\n        }\r\n\r\n        //update pumpkin Info \r\n        self.pumpkinInfoDict = {};\r\n        const pumpkin = roomDownsyncFrame.pumpkin;\r\n        const pumpkinsLocalIdStrList = Object.keys(pumpkin);\r\n        for (let i = 0; i < pumpkinsLocalIdStrList.length; ++i) {\r\n          const k = pumpkinsLocalIdStrList[i];\r\n          const pumpkinLocalIdInBattle = parseInt(k);\r\n          const pumpkinInfo = pumpkin[k];\r\n          self.pumpkinInfoDict[pumpkinLocalIdInBattle] = pumpkinInfo;\r\n        }\r\n\r\n\r\n        //update treasureInfoDict\r\n        self.treasureInfoDict = {};\r\n        const treasures = roomDownsyncFrame.treasures;\r\n        const treasuresLocalIdStrList = Object.keys(treasures);\r\n        for (let i = 0; i < treasuresLocalIdStrList.length; ++i) { //treasureInfoDict\r\n          const k = treasuresLocalIdStrList[i];\r\n          const treasureLocalIdInBattle = parseInt(k);\r\n          const treasureInfo = treasures[k];\r\n          self.treasureInfoDict[treasureLocalIdInBattle] = treasureInfo;\r\n        }\r\n\r\n        //update acceleratorInfoDict\r\n        self.acceleratorInfoDict = {};\r\n        const accelartors = roomDownsyncFrame.speedShoes;\r\n        const accLocalIdStrList = Object.keys(accelartors);\r\n        for (let i = 0; i < accLocalIdStrList.length; ++i) {\r\n          const k = accLocalIdStrList[i];\r\n          const accLocalIdInBattle = parseInt(k);\r\n          const accInfo = accelartors[k];\r\n          self.acceleratorInfoDict[accLocalIdInBattle] = accInfo;\r\n        }\r\n\r\n        //update trapInfoDict\r\n        self.trapInfoDict = {};\r\n        const traps = roomDownsyncFrame.traps;\r\n        const trapsLocalIdStrList = Object.keys(traps);\r\n        for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\r\n          const k = trapsLocalIdStrList[i];\r\n          const trapLocalIdInBattle = parseInt(k);\r\n          const trapInfo = traps[k];\r\n          self.trapInfoDict[trapLocalIdInBattle] = trapInfo;\r\n        }\r\n\r\n        self.trapBulletInfoDict = {};\r\n        const bullets = roomDownsyncFrame.bullets;\r\n        const bulletsLocalIdStrList = Object.keys(bullets);\r\n        for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\r\n          const k = bulletsLocalIdStrList[i];\r\n          const bulletLocalIdInBattle = parseInt(k);\r\n          const bulletInfo = bullets[k];\r\n          self.trapBulletInfoDict[bulletLocalIdInBattle] = bulletInfo;\r\n        }\r\n\r\n        // Update `guardTowerInfoDict`.\r\n        self.guardTowerInfoDict = {};\r\n        const guardTowers = roomDownsyncFrame.guardTowers;\r\n        const ids = Object.keys(guardTowers);\r\n        for (let i = 0; i < ids.length; ++i) {\r\n          const id = ids[i];\r\n          const localIdInBattle = parseInt(id);\r\n          const tower = guardTowers[id];\r\n          self.guardTowerInfoDict[localIdInBattle] = tower;\r\n        }\r\n\r\n        if (0 == self.lastRoomDownsyncFrameId) {\r\n          self.battleState = ALL_BATTLE_STATES.IN_BATTLE;\r\n          if (1 == frameId) {\r\n            // No need to prompt upon rejoined.\r\n            self.popupSimplePressToGo(i18n.t(\"gameTip.start\"));\r\n          }\r\n          self.onBattleStarted();\r\n        }\r\n        self.lastRoomDownsyncFrameId = frameId;\r\n      // TODO: Inject a NetworkDoctor as introduced in https://app.yinxiang.com/shard/s61/nl/13267014/5c575124-01db-419b-9c02-ec81f78c6ddc/.\r\n      };\r\n    }\r\n\r\n    // The player is now viewing \"self.gameRuleNode\" with button(s) to start an actual battle. -- YFLu\r\n    const expectedRoomId = window.getExpectedRoomIdSync();\r\n    console.warn(\"expectedRoomId: \", expectedRoomId);\r\n    if (null != expectedRoomId) {\r\n      self.disableGameRuleNode();\r\n      // The player is now viewing \"self.gameRuleNode\" with no button, and should wait for `self.initAfterWSConnected` to be called. -- YFLu\r\n      window.initPersistentSessionClient(self.initAfterWSConnected, expectedRoomId);\r\n    } else {\r\n      // Deliberately left blank. -- YFLu\r\n    }\r\n  },\r\n\r\n  disableGameRuleNode() {\r\n    const self = window.mapIns;\r\n    if (null != self.gameRuleNode && null != self.gameRuleNode.active && null != self.gameRuleScriptIns) {\r\n      self.gameRuleScriptIns.modeButton.active = false;\r\n    }\r\n  },\r\n\r\n  hideGameRuleNode() {\r\n    const self = window.mapIns;\r\n    if (null != self.gameRuleNode && null != self.gameRuleNode.active) {\r\n      self.gameRuleNode.active = false;\r\n    }\r\n  },\r\n\r\n  setupInputControls() {\r\n    const instance = window.mapIns;\r\n    const mapNode = instance.node;\r\n    const canvasNode = mapNode.parent;\r\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\r\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\r\n\r\n    const ctrl = joystickInputControllerScriptIns;\r\n    instance.ctrl = ctrl;\r\n\r\n    instance.inputControlTimer = setInterval(function() {\r\n      if (false == instance._inputControlEnabled) return;\r\n      if (instance.selfPlayerScriptIns != null && ctrl != null) {\r\n        instance.selfPlayerScriptIns.activeDirection = ctrl.activeDirection;\r\n      }\r\n    }, inputControlPollerMillis);\r\n  },\r\n\r\n  enableInputControls() {\r\n    this._inputControlEnabled = true;\r\n  },\r\n\r\n  disableInputControls() {\r\n    this._inputControlEnabled = false;\r\n  },\r\n\r\n  onBattleStarted() {\r\n    console.log('On battle started!');\r\n    const self = window.mapIns;\r\n    if (self.musicEffectManagerScriptIns) {\r\n      self.musicEffectManagerScriptIns.playBGM();\r\n    }\r\n    const canvasNode = self.canvasNode;\r\n    self.spawnSelfPlayer();\r\n    self.upsyncLoopInterval = setInterval(self._onPerUpsyncFrame.bind(self), self.clientUpsyncFps);\r\n    self.enableInputControls();\r\n    if (self.countdownToBeginGameNode.parent) {\r\n      self.countdownToBeginGameNode.parent.removeChild(self.countdownToBeginGameNode);\r\n    }\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    if (CC_DEBUG) {\r\n      if (self.testOnlyResyncInterval) {\r\n        clearInterval(self.testOnlyResyncInterval);\r\n      }\r\n      self.testOnlyResyncInterval = setInterval(() => {\r\n        self._lazilyTriggerResync();\r\n      }, 10 * 1000);\r\n    }\r\n  },\r\n\r\n  onBattleStopped(playerMetas, players) {\r\n    const self = this;\r\n    if (self.musicEffectManagerScriptIns) {\r\n      self.musicEffectManagerScriptIns.stopAllMusic();\r\n    }\r\n    const canvasNode = self.canvasNode;\r\n    const resultPanelNode = self.resultPanelNode;\r\n    const resultPanelScriptIns = resultPanelNode.getComponent(\"ResultPanel\");\r\n    resultPanelScriptIns.showPlayerInfo(playerMetas, players);\r\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n    // Such that it doesn't execute \"update(dt)\" anymore. \r\n    self.selfPlayerNode.active = false;\r\n    self.battleState = ALL_BATTLE_STATES.IN_SETTLEMENT;\r\n    self.showPopupInCanvas(resultPanelNode);\r\n\r\n    // Clear player info\r\n    self.playersInfoNode.getComponent(\"PlayersInfo\").clearInfo();\r\n  },\r\n\r\n  spawnSelfPlayer() {\r\n    const instance = this;\r\n    const joinIndex = this.selfPlayerInfo.joinIndex;\r\n    const newPlayerNode = this.playersNode[joinIndex];\r\n    const tiledMapIns = instance.node.getComponent(cc.TiledMap);\r\n    let toStartWithPos = cc.v2(instance.selfPlayerInfo.x, instance.selfPlayerInfo.y)\r\n    newPlayerNode.setPosition(toStartWithPos);\r\n    newPlayerNode.getComponent(\"SelfPlayer\").mapNode = instance.node;\r\n\r\n    instance.node.addChild(newPlayerNode);\r\n    instance.selfPlayerScriptIns = newPlayerNode.getComponent(\"SelfPlayer\");\r\n    instance.selfPlayerScriptIns.showArrowTipNode();\r\n\r\n    setLocalZOrder(newPlayerNode, 5);\r\n    instance.selfPlayerNode = newPlayerNode;\r\n  },\r\n\r\n  update(dt) {\r\n    const self = this;\r\n    try {\r\n      const mapNode = self.node;\r\n      const canvasNode = mapNode.parent;\r\n      const canvasParentNode = canvasNode.parent;\r\n      if (null != window.boundRoomId) {\r\n        self.boundRoomIdLabel.string = window.boundRoomId;\r\n      }\r\n      if (null != self.selfPlayerInfo) {\r\n        const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\r\n        playersScriptIns.updateData(self.selfPlayerInfo);\r\n        if (null != self.selfPlayerScriptIns) {\r\n          self.selfPlayerScriptIns.updateSpeed(self.selfPlayerInfo.speed);\r\n        }\r\n      }\r\n\r\n      let toRemoveAcceleratorNodeDict = {};\r\n      Object.assign(toRemoveAcceleratorNodeDict, self.acceleratorNodeDict);\r\n\r\n      let toRemovePlayerNodeDict = {};\r\n      Object.assign(toRemovePlayerNodeDict, self.otherPlayerNodeDict);\r\n\r\n      let toRemoveTreasureNodeDict = {};\r\n      Object.assign(toRemoveTreasureNodeDict, self.treasureNodeDict);\r\n\r\n      let toRemoveTrapNodeDict = {};\r\n      Object.assign(toRemoveTrapNodeDict, self.trapNodeDict);\r\n\r\n      let toRemovePumpkinNodeDict = {};\r\n      Object.assign(toRemovePumpkinNodeDict, self.pumpkinNodeDict);\r\n\r\n      /*\r\n      * NOTE: At the beginning of each GUI update cycle, mark all `self.trapBulletNode` as `toRemoveBulletNode`, while only those that persist in `self.trapBulletInfoDict` are NOT finally removed. This approach aims to reduce the lines of codes for coping with node removal in the RoomDownsyncFrame algorithm.\r\n      */\r\n      let toRemoveBulletNodeDict = {};\r\n      Object.assign(toRemoveBulletNodeDict, self.trapBulletNodeDict);\r\n\r\n      for (let k in self.otherPlayerCachedDataDict) {\r\n        const playerId = parseInt(k);\r\n        const cachedPlayerData = self.otherPlayerCachedDataDict[playerId];\r\n        const newPos = cc.v2(\r\n          cachedPlayerData.x,\r\n          cachedPlayerData.y\r\n        );\r\n\r\n        //\r\n        if (null != cachedPlayerData) {\r\n          const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\r\n          playersScriptIns.updateData(cachedPlayerData);\r\n        }\r\n        let targetNode = self.otherPlayerNodeDict[playerId];\r\n        if (!targetNode) {\r\n          targetNode = self.playersNode[cachedPlayerData.joinIndex];\r\n          targetNode.getComponent(\"SelfPlayer\").mapNode = mapNode;\r\n          self.otherPlayerNodeDict[playerId] = targetNode;\r\n          safelyAddChild(mapNode, targetNode);\r\n          targetNode.setPosition(newPos);\r\n          setLocalZOrder(targetNode, 5);\r\n        }\r\n        const aControlledOtherPlayerScriptIns = targetNode.getComponent(\"SelfPlayer\");\r\n        aControlledOtherPlayerScriptIns.updateSpeed(cachedPlayerData.speed);\r\n\r\n\r\n\r\n        const oldPos = cc.v2(\r\n          targetNode.x,\r\n          targetNode.y\r\n        );\r\n\r\n        const toMoveByVec = newPos.sub(oldPos);\r\n        const toMoveByVecMag = toMoveByVec.mag();\r\n        aControlledOtherPlayerScriptIns.toMoveByVecMag = toMoveByVecMag;\r\n        const toTeleportDisThreshold = (cachedPlayerData.speed * dt * 100);\r\n        //const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 0.5);\r\n        const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 1.0);\r\n        if (toMoveByVecMag < notToMoveDisThreshold) {\r\n          aControlledOtherPlayerScriptIns.activeDirection = { //0\r\n            dx: 0,\r\n            dy: 0\r\n          };\r\n        } else {\r\n          if (toMoveByVecMag > toTeleportDisThreshold) { // log\r\n            console.log(\"Player \", cachedPlayerData.id, \" is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == \", toTeleportDisThreshold);\r\n            aControlledOtherPlayerScriptIns.activeDirection = {\r\n              dx: 0,\r\n              dy: 0\r\n            };\r\n            // TODO: Use `cc.Action`?\r\n            targetNode.setPosition(newPos);\r\n          } else {\r\n            // The common case which is suitable for interpolation.\r\n            const normalizedDir = {\r\n              dx: toMoveByVec.x / toMoveByVecMag,\r\n              dy: toMoveByVec.y / toMoveByVecMag,\r\n            };\r\n            aControlledOtherPlayerScriptIns.toMoveByVec = toMoveByVec;\r\n            aControlledOtherPlayerScriptIns.toMoveByVecMag = toMoveByVecMag;\r\n\r\n            if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\r\n              aControlledOtherPlayerScriptIns.activeDirection = {\r\n                dx: 0,\r\n                dy: 0,\r\n              };\r\n            } else {\r\n              aControlledOtherPlayerScriptIns.activeDirection = normalizedDir;\r\n            }\r\n          }\r\n        }\r\n\r\n\r\n        if (0 != cachedPlayerData.dir.dx || 0 != cachedPlayerData.dir.dy) {\r\n          const newScheduledDirection = self.ctrl.discretizeDirection(cachedPlayerData.dir.dx, cachedPlayerData.dir.dy, self.ctrl.joyStickEps);\r\n          aControlledOtherPlayerScriptIns.scheduleNewDirection(newScheduledDirection, false /* DON'T interrupt playing anim. */ );\r\n        }\r\n\r\n        if (null != toRemovePlayerNodeDict[playerId]) {\r\n          delete toRemovePlayerNodeDict[playerId];\r\n        }\r\n\r\n\r\n      }\r\n\r\n      //  \r\n      for (let k in self.acceleratorInfoDict) {\r\n        const accLocalIdInBattle = parseInt(k);\r\n        const acceleratorInfo = self.acceleratorInfoDict[accLocalIdInBattle];\r\n        const newPos = cc.v2(\r\n          acceleratorInfo.x,\r\n          acceleratorInfo.y\r\n        );\r\n        let targetNode = self.acceleratorNodeDict[accLocalIdInBattle];\r\n        if (!targetNode) {\r\n          targetNode = cc.instantiate(self.acceleratorPrefab);\r\n          self.acceleratorNodeDict[accLocalIdInBattle] = targetNode;\r\n          safelyAddChild(mapNode, targetNode);\r\n          targetNode.setPosition(newPos);\r\n          setLocalZOrder(targetNode, 5);\r\n        }\r\n        if (null != toRemoveAcceleratorNodeDict[accLocalIdInBattle]) {\r\n          delete toRemoveAcceleratorNodeDict[accLocalIdInBattle];\r\n        }\r\n      }\r\n      //  \r\n      for (let k in self.trapInfoDict) {\r\n        const trapLocalIdInBattle = parseInt(k);\r\n        const trapInfo = self.trapInfoDict[trapLocalIdInBattle];\r\n        const newPos = cc.v2(\r\n          trapInfo.x,\r\n          trapInfo.y\r\n        );\r\n        let targetNode = self.trapNodeDict[trapLocalIdInBattle];\r\n        if (!targetNode) {\r\n          targetNode = cc.instantiate(self.trapPrefab);\r\n          self.trapNodeDict[trapLocalIdInBattle] = targetNode;\r\n          safelyAddChild(mapNode, targetNode);\r\n          targetNode.setPosition(newPos);\r\n          setLocalZOrder(targetNode, 5);\r\n        }\r\n        if (null != toRemoveTrapNodeDict[trapLocalIdInBattle]) {\r\n          delete toRemoveTrapNodeDict[trapLocalIdInBattle];\r\n        }\r\n      }\r\n\r\n      //  \r\n      for (let k in self.guardTowerInfoDict) {\r\n        const trapLocalIdInBattle = parseInt(k);\r\n        const towerInfo = self.guardTowerInfoDict[trapLocalIdInBattle];\r\n        const newPos = cc.v2(\r\n          towerInfo.x,\r\n          towerInfo.y\r\n        );\r\n        let targetNode = self.towerNodeDict[trapLocalIdInBattle];\r\n        if (!targetNode) {\r\n          targetNode = cc.instantiate(self.guardTowerPrefab);\r\n          self.towerNodeDict[trapLocalIdInBattle] = targetNode;\r\n          safelyAddChild(mapNode, targetNode);\r\n          targetNode.setPosition(newPos);\r\n          setLocalZOrder(targetNode, 5);\r\n        }\r\n      }\r\n\r\n      // bullet \r\n      for (let k in self.trapBulletInfoDict) {\r\n        const bulletLocalIdInBattle = parseInt(k);\r\n        const bulletInfo = self.trapBulletInfoDict[bulletLocalIdInBattle];\r\n        const newPos = cc.v2(\r\n          bulletInfo.x,\r\n          bulletInfo.y\r\n        );\r\n        let targetNode = self.trapBulletNodeDict[bulletLocalIdInBattle];\r\n        if (!targetNode) {\r\n          targetNode = cc.instantiate(self.trapBulletPrefab);\r\n\r\n          targetNode.rotation = (() => {\r\n            if (true == bulletInfo.remove) {\r\n              return null;\r\n            }\r\n            if (null == bulletInfo.startAtPoint || null == bulletInfo.endAtPoint) {\r\n              console.error(`Init bullet direction error, startAtPoint:${bulletInfo.startAtPoint}, endAtPoint:${bulletInfo.endAtPoint}`);\r\n              return null;\r\n            } else {\r\n              const dx = bulletInfo.endAtPoint.x - bulletInfo.startAtPoint.x;\r\n              const dy = bulletInfo.endAtPoint.y - bulletInfo.startAtPoint.y;\r\n              const radian = (() => {\r\n                if (dx == 0) {\r\n                  return Math.PI / 2;\r\n                } else {\r\n                  return Math.abs(Math.atan(dy / dx));\r\n                }\r\n              })();\r\n              const angleTemp = radian * 180 / Math.PI;\r\n              const angle = (() => {\r\n                if (dx >= 0) {\r\n                  if (dy >= 0) {\r\n                    //\r\n                    return 360 - angleTemp;\r\n                  //return angleTemp;\r\n                  } else {\r\n                    //\r\n                    return angleTemp;\r\n                  //return -angleTemp;\r\n                  }\r\n                } else {\r\n                  if (dy >= 0) {\r\n                    //\r\n                    return 360 - (180 - angleTemp);\r\n                  //return 180 - angleTemp;\r\n                  } else {\r\n                    //\r\n                    return 360 - (180 + angleTemp);\r\n                  //return 180 + angleTemp;\r\n                  }\r\n                }\r\n              })();\r\n              return angle;\r\n            }\r\n          })();\r\n\r\n          if (null == targetNode.rotation) {\r\n            continue;  \r\n          }\r\n\r\n          self.trapBulletNodeDict[bulletLocalIdInBattle] = targetNode;\r\n          safelyAddChild(mapNode, targetNode);\r\n          targetNode.setPosition(newPos);\r\n          setLocalZOrder(targetNode, 5);\r\n        }\r\n        const aBulletScriptIns = targetNode.getComponent(\"Bullet\");\r\n        aBulletScriptIns.localIdInBattle = bulletLocalIdInBattle;\r\n        aBulletScriptIns.linearSpeed = bulletInfo.linearSpeed * 1000000000; // The `bullet.LinearSpeed` on server-side is denoted in pts/nanoseconds. \r\n\r\n        const oldPos = cc.v2(\r\n          targetNode.x,\r\n          targetNode.y,\r\n        );\r\n        const toMoveByVec = newPos.sub(oldPos);\r\n        const toMoveByVecMag = toMoveByVec.mag();\r\n        const toTeleportDisThreshold = (aBulletScriptIns.linearSpeed * dt * 100);\r\n        const notToMoveDisThreshold = (aBulletScriptIns.linearSpeed * dt * 0.5);\r\n        if (toMoveByVecMag < notToMoveDisThreshold) {\r\n          aBulletScriptIns.activeDirection = {\r\n            dx: 0,\r\n            dy: 0,\r\n          };\r\n        } else {\r\n          if (toMoveByVecMag > toTeleportDisThreshold) {\r\n            console.log(\"Bullet \", bulletLocalIdInBattle, \" is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == \", toTeleportDisThreshold);\r\n            aBulletScriptIns.activeDirection = {\r\n              dx: 0,\r\n              dy: 0\r\n            };\r\n            // TODO: Use `cc.Action`?\r\n            targetNode.setPosition(newPos);\r\n          } else {\r\n            // The common case which is suitable for interpolation.\r\n            const normalizedDir = {\r\n              dx: toMoveByVec.x / toMoveByVecMag,\r\n              dy: toMoveByVec.y / toMoveByVecMag,\r\n            };\r\n            if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\r\n              aBulletScriptIns.activeDirection = {\r\n                dx: 0,\r\n                dy: 0,\r\n              };\r\n            } else {\r\n              aBulletScriptIns.activeDirection = normalizedDir;\r\n            }\r\n          }\r\n        }\r\n        if (null != toRemoveBulletNodeDict[bulletLocalIdInBattle]) {\r\n          delete toRemoveBulletNodeDict[bulletLocalIdInBattle];\r\n        }\r\n      }\r\n\r\n      //\r\n      for (let k in self.pumpkinInfoDict) {\r\n        const pumpkinLocalIdInBattle = parseInt(k);\r\n        const pumpkinInfo = self.pumpkinInfoDict[pumpkinLocalIdInBattle];\r\n        const newPos = cc.v2(pumpkinInfo.x, pumpkinInfo.y);\r\n        let targetNode = self.pumpkinNodeDict[pumpkinLocalIdInBattle];\r\n        if (!targetNode) {\r\n          targetNode = cc.instantiate(self.pumpkinPrefab);\r\n          self.pumpkinNodeDict[pumpkinLocalIdInBattle] = targetNode;\r\n          safelyAddChild(mapNode, targetNode);\r\n          targetNode.setPosition(newPos);\r\n          setLocalZOrder(targetNode, 5);\r\n        }\r\n        const aPumpkinScriptIns = targetNode.getComponent(\"Pumpkin\");\r\n        aPumpkinScriptIns.localIdInBattle = pumpkinLocalIdInBattle;\r\n        aPumpkinScriptIns.linearSpeed = pumpkinInfo.linearSpeed * 1000000000; // The `pumpkin.LinearSpeed` on server-side is denoted in pts/nanoseconds. \r\n\r\n        const oldPos = cc.v2(\r\n          targetNode.x,\r\n          targetNode.y,\r\n        );\r\n        const toMoveByVec = newPos.sub(oldPos);\r\n        const toMoveByVecMag = toMoveByVec.mag();\r\n        const toTeleportDisThreshold = (aPumpkinScriptIns.linearSpeed * dt * 100);\r\n        const notToMoveDisThreshold = (aPumpkinScriptIns.linearSpeed * dt * 0.5);\r\n        if (toMoveByVecMag < notToMoveDisThreshold) {\r\n          aPumpkinScriptIns.activeDirection = {\r\n            dx: 0,\r\n            dy: 0,\r\n          };\r\n        } else {\r\n          if (toMoveByVecMag > toTeleportDisThreshold) {\r\n            console.log(\"Pumpkin \", pumpkinLocalIdInBattle, \" is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == \", toTeleportDisThreshold);\r\n            aPumpkinScriptIns.activeDirection = {\r\n              dx: 0,\r\n              dy: 0\r\n            };\r\n            // TODO: Use `cc.Action`?\r\n            targetNode.setPosition(newPos);\r\n          } else {\r\n            // The common case which is suitable for interpolation.\r\n            const normalizedDir = {\r\n              dx: toMoveByVec.x / toMoveByVecMag,\r\n              dy: toMoveByVec.y / toMoveByVecMag,\r\n            };\r\n            if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\r\n              aPumpkinScriptIns.activeDirection = {\r\n                dx: 0,\r\n                dy: 0,\r\n              };\r\n            } else {\r\n              aPumpkinScriptIns.activeDirection = normalizedDir;\r\n            }\r\n          }\r\n        }\r\n        if (null != toRemovePumpkinNodeDict[pumpkinLocalIdInBattle]) {\r\n          delete toRemovePumpkinNodeDict[pumpkinLocalIdInBattle];\r\n        }\r\n      }\r\n\r\n      //  \r\n      for (let k in self.treasureInfoDict) {\r\n        const treasureLocalIdInBattle = parseInt(k);\r\n        const treasureInfo = self.treasureInfoDict[treasureLocalIdInBattle];\r\n        const newPos = cc.v2(\r\n          treasureInfo.x,\r\n          treasureInfo.y\r\n        );\r\n        let targetNode = self.treasureNodeDict[treasureLocalIdInBattle];\r\n        if (!targetNode) {\r\n          targetNode = cc.instantiate(self.treasurePrefab);\r\n          const treasureNodeScriptIns = targetNode.getComponent(\"Treasure\");\r\n          treasureNodeScriptIns.setData(treasureInfo);\r\n          self.treasureNodeDict[treasureLocalIdInBattle] = targetNode;\r\n          safelyAddChild(mapNode, targetNode);\r\n          targetNode.setPosition(newPos);\r\n          setLocalZOrder(targetNode, 5);\r\n        }\r\n\r\n        if (null != toRemoveTreasureNodeDict[treasureLocalIdInBattle]) {\r\n          delete toRemoveTreasureNodeDict[treasureLocalIdInBattle];\r\n        }\r\n        if (0 < targetNode.getNumberOfRunningActions()) {\r\n          // A significant trick to smooth the position sync performance!\r\n          continue;\r\n        }\r\n        const oldPos = cc.v2(\r\n          targetNode.x,\r\n          targetNode.y\r\n        );\r\n        const toMoveByVec = newPos.sub(oldPos);\r\n        const durationSeconds = dt; // Using `dt` temporarily!\r\n        targetNode.runAction(cc.moveTo(durationSeconds, newPos));\r\n      }\r\n\r\n      // Coping with removed players.\r\n      for (let k in toRemovePlayerNodeDict) {\r\n        const playerId = parseInt(k);\r\n        toRemovePlayerNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\r\n        delete self.otherPlayerNodeDict[playerId];\r\n      }\r\n\r\n      // Coping with removed pumpkins.\r\n      for (let k in toRemovePumpkinNodeDict) {\r\n        const pumpkinLocalIdInBattle = parseInt(k);\r\n        toRemovePumpkinNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\r\n        delete self.pumpkinNodeDict[pumpkinLocalIdInBattle];\r\n      }\r\n\r\n      // Coping with removed treasures.\r\n      for (let k in toRemoveTreasureNodeDict) {\r\n        const treasureLocalIdInBattle = parseInt(k);\r\n        const treasureScriptIns = toRemoveTreasureNodeDict[k].getComponent(\"Treasure\");\r\n        treasureScriptIns.playPickedUpAnimAndDestroy();\r\n        if (self.musicEffectManagerScriptIns) {\r\n          if (2 == treasureScriptIns.type) {\r\n            self.musicEffectManagerScriptIns.playHighScoreTreasurePicked();\r\n          } else {\r\n            self.musicEffectManagerScriptIns.playTreasurePicked();\r\n          }\r\n        }\r\n        delete self.treasureNodeDict[treasureLocalIdInBattle];\r\n      }\r\n\r\n      // Coping with removed traps.\r\n      for (let k in toRemoveTrapNodeDict) {\r\n        const trapLocalIdInBattle = parseInt(k);\r\n        toRemoveTrapNodeDict[k].parent.removeChild(toRemoveTrapNodeDict[k]);\r\n        delete self.trapNodeDict[trapLocalIdInBattle];\r\n      }\r\n\r\n      // Coping with removed accelerators.\r\n      for (let k in toRemoveAcceleratorNodeDict) {\r\n        const accLocalIdInBattle = parseInt(k);\r\n        toRemoveAcceleratorNodeDict[k].parent.removeChild(toRemoveAcceleratorNodeDict[k]);\r\n        delete self.acceleratorNodeDict[accLocalIdInBattle];\r\n      }\r\n\r\n      // Coping with removed bullets.\r\n      for (let k in toRemoveBulletNodeDict) {\r\n        const bulletLocalIdInBattle = parseInt(k);\r\n        toRemoveBulletNodeDict[k].parent.removeChild(toRemoveBulletNodeDict[k]);\r\n        delete self.trapBulletNodeDict[bulletLocalIdInBattle];\r\n        if (self.musicEffectManagerScriptIns) {\r\n          self.musicEffectManagerScriptIns.playCrashedByTrapBullet();\r\n        }\r\n      }\r\n    } catch (err) {\r\n      console.warn(\"Map.update(dt), resync\", err);\r\n      self._lazilyTriggerResync();\r\n    }\r\n  },\r\n\r\n  transitToState(s) {\r\n    const self = this;\r\n    self.state = s;\r\n  },\r\n\r\n  logout(byClick /* The case where this param is \"true\" will be triggered within `ConfirmLogout.js`.*/ , shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    const self = this;\r\n    const localClearance = () => {\r\n      self.clearLocalStorageAndBackToLoginScene(shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\r\n    }\r\n\r\n    const selfPlayerStr = cc.sys.localStorage.getItem(\"selfPlayer\");\r\n    if (null != selfPlayerStr) {\r\n      const selfPlayer = JSON.parse(selfPlayerStr);\r\n      const requestContent = {\r\n        intAuthToken: selfPlayer.intAuthToken\r\n      };\r\n      try {\r\n        NetworkUtils.ajax({\r\n          url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\r\n          type: \"POST\",\r\n          data: requestContent,\r\n          success: function(res) {\r\n            if (res.ret != constants.RET_CODE.OK) {\r\n              console.log(\"Logout failed: \", res);\r\n            }\r\n            localClearance();\r\n          },\r\n          error: function(xhr, status, errMsg) {\r\n            localClearance();\r\n          },\r\n          timeout: function() {\r\n            localClearance();\r\n          }\r\n        });\r\n      } catch (e) {} finally {\r\n        // For Safari (both desktop and mobile).\r\n        localClearance();\r\n      }\r\n    } else {\r\n      localClearance();\r\n    }\r\n  },\r\n\r\n  onLogoutClicked(evt) {\r\n    const self = this;\r\n    self.showPopupInCanvas(self.confirmLogoutNode);\r\n  },\r\n\r\n  onLogoutConfirmationDismissed() {\r\n    const self = this;\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    const canvasNode = self.canvasNode;\r\n    canvasNode.removeChild(self.confirmLogoutNode);\r\n    self.enableInputControls();\r\n  },\r\n\r\n  onGameRule1v1ModeClicked(evt, cb) {\r\n    const self = this;\r\n    window.initPersistentSessionClient(self.initAfterWSConnected, null /* Deliberately NOT passing in any `expectedRoomId`. -- YFLu */ );\r\n    self.hideGameRuleNode();\r\n  },\r\n\r\n  showPopupInCanvas(toShowNode) {\r\n    const self = this;\r\n    self.disableInputControls();\r\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\r\n    safelyAddChild(self.widgetsAboveAllNode, toShowNode);\r\n    setLocalZOrder(toShowNode, 10);\r\n  },\r\n\r\n  playersMatched(playerMetas) {\r\n    console.log(\"Calling `playersMatched` with:\", playerMetas);\r\n\r\n    const self = this;\r\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n    findingPlayerScriptIns.updatePlayersInfo(playerMetas);\r\n    window.setTimeout(() => {\r\n      if (self.findingPlayerNode.parent) {\r\n        self.findingPlayerNode.parent.removeChild(self.findingPlayerNode);\r\n        self.transitToState(ALL_MAP_STATES.VISUAL);\r\n        for (let i in playerMetas) {\r\n          const playerMeta = playerMetas[i];\r\n          const playersInfoScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\r\n          playersInfoScriptIns.updateData(playerMeta);\r\n        }\r\n      }\r\n      const countDownScriptIns = self.countdownToBeginGameNode.getComponent(\"CountdownToBeginGame\");\r\n      countDownScriptIns.setData();\r\n      self.showPopupInCanvas(self.countdownToBeginGameNode);\r\n      return;\r\n    }, 2000);\r\n  },\r\n\r\n});\r\n"]}