{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","ALL_BATTLE_STATES","WAITING","IN_BATTLE","IN_SETTLEMENT","IN_DISMISSAL","cc","Class","extends","Component","properties","useDiffFrameAlgo","default","canvasNode","type","Node","tiledAnimPrefab","Prefab","player1Prefab","player2Prefab","treasurePrefab","trapPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","simplePressToGoDialogPrefab","boundRoomIdLabel","Label","countdownLabel","trapBulletPrefab","resultPanelPrefab","gameRulePrefab","findingPlayerPrefab","countdownToBeginGamePrefab","playersInfoPrefab","_generateNewFullFrame","refFullFrame","diffFrame","newFullFrame","id","treasures","traps","bullets","players","playersLocalIdStrList","Object","keys","i","length","k","playerId","parseInt","removed","treasuresLocalIdStrList","treasureLocalIdInBattle","trapsLocalIdStrList","trapLocalIdInBattle","bulletsLocalIdStrList","bulletLocalIdInBattle","_dumpToFullFrameCache","fullFrame","self","recentFrameCacheCurrentSize","recentFrameCacheMaxCount","toDelFrameId","recentFrameCache","_onPerUpsyncFrame","instance","resyncing","selfPlayerInfo","selfPlayerScriptIns","scheduledDirection","upsyncFrameData","dir","dx","parseFloat","dy","x","selfPlayerNode","y","ackingFrameId","lastRoomDownsyncFrameId","wrapped","msgId","Date","now","act","data","sendSafely","JSON","stringify","onDestroy","handleRoomDownsyncFrame","upsyncLoopInterval","clearInterval","inputControlTimer","_lazilyTriggerResync","state","popupSimplePressToGo","_onResyncCompleted","log","labelString","simplePressToGoDialogNode","instantiate","setPosition","v2","setScale","scale","simplePressToGoDialogScriptIns","getComponent","yesButton","getChildByName","postDismissalByYes","transitToState","removeChild","string","once","dismissDialog","bind","safelyAddChild","widgetsAboveAllNode","setLocalZOrder","alertForGoingBackToLoginScene","mapIns","shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage","millisToGo","js","formatStr","setTimeout","logout","_resetCurrentMatch","mapNode","node","parent","playersNode","Animation","play","start","active","otherPlayerNodeDict","treasureNodeDict","trapBulletNodeDict","trapNodeDict","mainCameraNode","mainCamera","Camera","children","child","zoomRatio","battleState","otherPlayerCachedDataDict","treasureInfoDict","trapInfoDict","trapBulletInfoDict","findingPlayerNode","findingPlayerScriptIns","showPopopInCanvas","gameRuleNode","playersInfoNode","onLoad","director","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","confirmLogoutNode","resultPanelNode","resultPanelScriptIns","mapScriptIns","onAgainClicked","shouldReconnectState","sys","localStorage","clientSession","readyState","WebSocket","OPEN","initPersistentSessionClient","initAfterWSConncted","closeWSConnection","gameRuleScriptIns","countdownToBeginGameNode","player1Node","player2Node","assign","clientUpsyncFps","tiledMapIns","TiledMap","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","posInMapNode","width","sizeInMapNode","height","origSize","setAnchorPoint","addClip","animationClip","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","sheltersZReducer","newShelter","newShelterColliderIns","handleClientSessionCloseOrError","removeItem","parse","selfPlayer","_inputControlEnabled","setupInputControls","refFrameId","matchPlayersFinsihed","updatePlayersInfo","frameId","isInitiatingFrame","cachedFullFrame","countdownNanos","countdownSeconds","isNaN","roomDownsyncFrame","onBattleStopped","sentAt","playerIdStrList","immediateSelfPlayerInfo","speed","score","joinIndex","anotherPlayer","treasureInfo","trapInfo","bulletInfo","onBattleStarted","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","ctrl","setInterval","activeDirection","enableInputControls","disableInputControls","spawnSelfPlayer","showPlayerInfo","clearBoundRoomIdInBothVolatileAndPersistentStorage","newPlayerNode","toStartWithPos","showArrowTipNode","update","dt","canvasParentNode","boundRoomId","playersScriptIns","updateData","updateSpeed","toRemovePlayerNodeDict","toRemoveTreasureNodeDict","toRemoveTrapNodeDict","toRemoveBulletNodeDict","cachedPlayerData","newPos","targetNode","aControlledOtherPlayerScriptIns","oldPos","toMoveByVec","toMoveByVecMag","mag","toTeleportDisThreshold","notToMoveDisThreshold","normalizedDir","newScheduledDirection","discretizeDirection","joyStickEps","scheduleNewDirection","aBulletScriptIns","localIdInBattle","linearSpeed","treasureNodeScriptIns","setData","getNumberOfRunningActions","durationSeconds","runAction","moveTo","treasureScriptIns","playPickedUpAnimAndDestroy","s","byClick","localClearance","loadScene","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","constants","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","success","res","ret","RET_CODE","OK","error","xhr","status","errMsg","timeout","e","onLogoutClicked","evt","onLogoutConfirmationDismissed","initWSConnection","cb","toShowNode","playerInfo","countDownScriptIns"],"mappings":"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","file":"Map.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["const i18n = require('LanguageData');\r\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\r\n\r\nwindow.ALL_MAP_STATES = {\r\n  VISUAL: 0, // For free dragging & zooming.\r\n  EDITING_BELONGING: 1,\r\n  SHOWING_MODAL_POPUP: 2,\r\n};\r\n\r\nwindow.ALL_BATTLE_STATES = {\r\n  WAITING: 0,\r\n  IN_BATTLE: 1,\r\n  IN_SETTLEMENT: 2,\r\n  IN_DISMISSAL: 3,\r\n};\r\n\r\ncc.Class({\r\n  extends: cc.Component,\r\n\r\n  properties: {\r\n    useDiffFrameAlgo: {\r\n      default: true\r\n    },\r\n    canvasNode: {\r\n      type: cc.Node,\r\n      default: null,\r\n    },\r\n    tiledAnimPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    player1Prefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    player2Prefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    treasurePrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    trapPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    barrierPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    shelterPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    shelterZReducerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    keyboardInputControllerNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    joystickInputControllerNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    confirmLogoutPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    simplePressToGoDialogPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    boundRoomIdLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    countdownLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    trapBulletPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    resultPanelPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    gameRulePrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    findingPlayerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    countdownToBeginGamePrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    playersInfoPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n\r\n  },\r\n\r\n  _generateNewFullFrame: function(refFullFrame, diffFrame) {\r\n    let newFullFrame = {\r\n      id: diffFrame.id,\r\n      treasures: refFullFrame.treasures,\r\n      traps: refFullFrame.traps,\r\n      bullets: refFullFrame.bullets,\r\n      players: refFullFrame.players,\r\n    };\r\n\r\n    const players = diffFrame.players;\r\n    const playersLocalIdStrList = Object.keys(players);\r\n    for (let i = 0; i < playersLocalIdStrList.length; ++i) {\r\n      const k = playersLocalIdStrList[i];\r\n      const playerId = parseInt(k);\r\n      if (true == diffFrame.players[playerId].removed) {\r\n        // cc.log(`Player id == ${playerId} is removed.`);\r\n        delete newFullFrame.players[playerId];\r\n      } else {\r\n        newFullFrame.players[playerId] = diffFrame.players[playerId];\r\n      }\r\n    }\r\n\r\n    const treasures = diffFrame.treasures;\r\n    const treasuresLocalIdStrList = Object.keys(treasures);\r\n    for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\r\n      const k = treasuresLocalIdStrList[i];\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.treasures[treasureLocalIdInBattle].removed) {\r\n        // cc.log(`Treasure with localIdInBattle == ${treasureLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.treasures[treasureLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.treasures[treasureLocalIdInBattle] = diffFrame.treasures[treasureLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const traps = diffFrame.traps;\r\n    const trapsLocalIdStrList = Object.keys(traps);\r\n    for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\r\n      const k = trapsLocalIdStrList[i];\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.traps[trapLocalIdInBattle].removed) {\r\n        // cc.log(`Trap with localIdInBattle == ${trapLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.traps[trapLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.traps[trapLocalIdInBattle] = diffFrame.traps[trapLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    const bullets = diffFrame.bullets;\r\n    const bulletsLocalIdStrList = Object.keys(bullets);\r\n    for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\r\n      const k = bulletsLocalIdStrList[i];\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.bullets[bulletLocalIdInBattle].removed) {\r\n        // cc.log(`Bullet with localIdInBattle == ${bulletLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.bullets[bulletLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.bullets[bulletLocalIdInBattle] = diffFrame.bullets[bulletLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    return newFullFrame;\r\n  },\r\n\r\n  _dumpToFullFrameCache: function(fullFrame) {\r\n    const self = this;\r\n    while (self.recentFrameCacheCurrentSize >= self.recentFrameCacheMaxCount) {\r\n      // Trick here: never evict the \"Zero-th Frame\" for resyncing!\r\n      const toDelFrameId = Object.keys(self.recentFrameCache)[1];\r\n      // cc.log(\"toDelFrameId is \" + toDelFrameId + \".\");\r\n      delete self.recentFrameCache[toDelFrameId];\r\n      --self.recentFrameCacheCurrentSize;\r\n    }\r\n    self.recentFrameCache[fullFrame.id] = fullFrame;\r\n    ++self.recentFrameCacheCurrentSize;\r\n  },\r\n\r\n  _onPerUpsyncFrame() {\r\n    const instance = this;\r\n    if (instance.resyncing) return;\r\n    if (\r\n      null == instance.selfPlayerInfo ||\r\n      null == instance.selfPlayerScriptIns ||\r\n      null == instance.selfPlayerScriptIns.scheduledDirection\r\n      ) return;\r\n    const upsyncFrameData = {\r\n      id: instance.selfPlayerInfo.id,\r\n      /**\r\n      * WARNING\r\n      *\r\n      * Deliberately NOT upsyncing the `instance.selfPlayerScriptIns.activeDirection` here, because it'll be deduced by other players from the position differences of `RoomDownsyncFrame`s.\r\n      */\r\n      dir: {\r\n        dx: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dx),\r\n        dy: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dy),\r\n      },\r\n      x: parseFloat(instance.selfPlayerNode.x),\r\n      y: parseFloat(instance.selfPlayerNode.y),\r\n      ackingFrameId: instance.lastRoomDownsyncFrameId,\r\n    };\r\n    const wrapped = {\r\n      msgId: Date.now(),\r\n      act: \"PlayerUpsyncCmd\",\r\n      data: upsyncFrameData,\r\n    }\r\n    window.sendSafely(JSON.stringify(wrapped));\r\n  },\r\n\r\n  onDestroy() {\r\n    const self = this;\r\n    if (null != window.handleRoomDownsyncFrame) {\r\n      window.handleRoomDownsyncFrame = null;\r\n    }\r\n    if (self.upsyncLoopInterval) {\r\n      clearInterval(self.upsyncLoopInterval);\r\n    }\r\n    if (self.inputControlTimer) {\r\n      clearInterval(self.inputControlTimer)\r\n    }\r\n  },\r\n\r\n  _lazilyTriggerResync() {\r\n    if (true == this.resyncing) return;\r\n    this.resyncing = false;\r\n    if (ALL_MAP_STATES.SHOWING_MODAL_POPUP != this.state) {\r\n      this.popupSimplePressToGo(\"Resyncing your battle, please wait...\");\r\n    }\r\n  },\r\n\r\n  _onResyncCompleted() {\r\n    if (false == this.resyncing) return;\r\n    cc.log(`_onResyncCompleted`);\r\n    this.resyncing = true;\r\n  },\r\n\r\n  popupSimplePressToGo(labelString) {\r\n    const self = this;\r\n    self.state = ALL_MAP_STATES.SHOWING_MODAL_POPUP;\r\n\r\n    const canvasNode = self.canvasNode;\r\n    const simplePressToGoDialogNode = cc.instantiate(self.simplePressToGoDialogPrefab);\r\n    simplePressToGoDialogNode.setPosition(cc.v2(0, 0));\r\n    simplePressToGoDialogNode.setScale(1 / canvasNode.scale);\r\n    const simplePressToGoDialogScriptIns = simplePressToGoDialogNode.getComponent(\"SimplePressToGoDialog\");\r\n    const yesButton = simplePressToGoDialogNode.getChildByName(\"Yes\");\r\n    const postDismissalByYes = () => {\r\n      self.transitToState(ALL_MAP_STATES.VISUAL);\r\n      canvasNode.removeChild(simplePressToGoDialogNode);\r\n    }\r\n    simplePressToGoDialogNode.getChildByName(\"Hint\").getComponent(cc.Label).string = labelString;\r\n    yesButton.once(\"click\", simplePressToGoDialogScriptIns.dismissDialog.bind(simplePressToGoDialogScriptIns, postDismissalByYes));\r\n    yesButton.getChildByName(\"Label\").getComponent(cc.Label).string = \"OK\";\r\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\r\n    safelyAddChild(self.widgetsAboveAllNode, simplePressToGoDialogNode);\r\n    setLocalZOrder(simplePressToGoDialogNode, 20);\r\n  },\r\n\r\n  alertForGoingBackToLoginScene(labelString, mapIns, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    const millisToGo = 3000;\r\n    mapIns.popupSimplePressToGo(cc.js.formatStr(\"%s will logout in %s seconds.\", labelString, millisToGo / 1000));\r\n    setTimeout(() => {\r\n      mapIns.logout(false, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\r\n    }, millisToGo);\r\n  },\r\n\r\n  _resetCurrentMatch() {\r\n    const self = this;\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    self.countdownLabel.string = \"\";\r\n    if(self.playersNode) {\r\n      for (let i in self.playersNode) {\r\n        let node = self.playersNode[i];\r\n        node.getComponent(cc.Animation).play(\"Bottom\");\r\n        node.getComponent(\"SelfPlayer\").start();  \r\n        node.active = true;\r\n      }\r\n    }\r\n    if (self.otherPlayerNodeDict) {\r\n      for (let i in self.otherPlayerNodeDict) {\r\n        let node = self.otherPlayerNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n    if (self.selfPlayerNode && self.selfPlayerNode.parent) {\r\n      self.selfPlayerNode.parent.removeChild(self.selfPlayerNode);\r\n    }\r\n    if(self.treasureNodeDict) {\r\n      for (let i in self.treasureNodeDict) {\r\n        let node = self.treasureNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n    if(self.trapBulletNodeDict) {\r\n      for (let i in self.trapBulletNodeDict) {\r\n        let node = self.trapBulletNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n    if(self.trapNodeDict) {\r\n      for (let i in self.trapNodeDict) {\r\n      let node = self.trapNodeDict[i];\r\n        if (node.parent) {\r\n          node.parent.removeChild(node);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (self.upsyncLoopInterval) {\r\n      clearInterval(self.upsyncLoopInterval);\r\n    }\r\n\r\n    self.mainCameraNode = canvasNode.getChildByName(\"Main Camera\");\r\n    self.mainCamera = self.mainCameraNode.getComponent(cc.Camera);\r\n    for (let child of self.mainCameraNode.children) {\r\n      child.setScale(1 / self.mainCamera.zoomRatio);\r\n    }\r\n    self.widgetsAboveAllNode = self.mainCameraNode.getChildByName(\"WidgetsAboveAll\");\r\n    self.mainCameraNode.setPosition(cc.v2());\r\n\r\n    self.resyncing = false;\r\n    self.lastRoomDownsyncFrameId = 0;\r\n\r\n    self.recentFrameCache = {};\r\n    self.recentFrameCacheCurrentSize = 0;\r\n    self.recentFrameCacheMaxCount = 2048;\r\n    self.selfPlayerNode = null;\r\n    self.selfPlayerScriptIns = null;\r\n    self.selfPlayerInfo = null;\r\n    self.upsyncLoopInterval = null;\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n\r\n    self.battleState = ALL_BATTLE_STATES.WAITING;\r\n    self.otherPlayerCachedDataDict = {};\r\n    self.otherPlayerNodeDict = {};\r\n    self.treasureInfoDict = {};\r\n    self.treasureNodeDict = {};\r\n    self.trapInfoDict = {};\r\n    self.trapBulletInfoDict = {};\r\n    self.trapBulletNodeDict = {};\r\n    self.trapNodeDict = {};\r\n    if (self.findingPlayerNode) {\r\n      const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");  \r\n      findingPlayerScriptIns.init();\r\n    }\r\n    self.showPopopInCanvas(self.gameRuleNode);\r\n    safelyAddChild(self.widgetsAboveAllNode, self.playersInfoNode);\r\n  },\r\n\r\n  onLoad() {\r\n    const self = this;\r\n\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    cc.director.getCollisionManager().enabled = true;\r\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\r\n\r\n    /** init requeired prefab started */\r\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\r\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\r\n\r\n    self.resultPanelNode = cc.instantiate(self.resultPanelPrefab);\r\n    const resultPanelScriptIns = self.resultPanelNode.getComponent(\"ResultPanel\");\r\n    resultPanelScriptIns.mapScriptIns = self;\r\n    resultPanelScriptIns.onAgainClicked = () => {\r\n      self._resetCurrentMatch();\r\n      let shouldReconnectState = parseInt(cc.sys.localStorage.shouldReconnectState); \r\n      switch (shouldReconnectState) {\r\n        case 2:\r\n        case 1:\r\n          // Clicking too fast?\r\n          return;\r\n        default:\r\n          break;\r\n      }\r\n      if (null == window.clientSession || window.clientSession.readyState != WebSocket.OPEN) {\r\n        // Already disconnected. \r\n        cc.log(\"Ws session is already closed when `again/replay` button is clicked. Reconnecting now.\");\r\n        window.initPersistentSessionClient(self.initAfterWSConncted);\r\n      } else {\r\n        // Should disconnect first and reconnect within `window.handleClientSessionCloseOrError`. \r\n        cc.log(\"Ws session is not closed yet when `again/replay` button is clicked, closing the ws session now.\");\r\n        cc.sys.localStorage.shouldReconnectState = 2;\r\n        window.closeWSConnection();\r\n      }\r\n    };\r\n\r\n    self.gameRuleNode = cc.instantiate(self.gameRulePrefab);\r\n    self.gameRuleScriptIns = self.gameRuleNode.getComponent(\"GameRule\");\r\n    self.gameRuleScriptIns.mapNode = self.node;\r\n\r\n    self.findingPlayerNode = cc.instantiate(self.findingPlayerPrefab);\r\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n    findingPlayerScriptIns.init();\r\n\r\n    self.playersInfoNode = cc.instantiate(self.playersInfoPrefab);\r\n\r\n    self.countdownToBeginGameNode = cc.instantiate(self.countdownToBeginGamePrefab);\r\n\r\n    self.playersNode = {};\r\n    const player1Node = cc.instantiate(self.player1Prefab);\r\n    const player2Node = cc.instantiate(self.player2Prefab);\r\n    Object.assign(self.playersNode, {\r\n      1: player1Node\r\n    });\r\n    Object.assign(self.playersNode, {\r\n      2: player2Node\r\n    });\r\n    /** init requeired prefab ended */\r\n\r\n    self.clientUpsyncFps = 20;\r\n    self._resetCurrentMatch();\r\n\r\n    const tiledMapIns = self.node.getComponent(cc.TiledMap);\r\n    const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node);\r\n    for (let frameAnim of boundaryObjs.frameAnimations) {\r\n      const animNode = cc.instantiate(self.tiledAnimPrefab);\r\n      const anim = animNode.getComponent(cc.Animation);\r\n      animNode.setPosition(frameAnim.posInMapNode);\r\n      animNode.width = frameAnim.sizeInMapNode.width;\r\n      animNode.height = frameAnim.sizeInMapNode.height;\r\n      animNode.setScale(frameAnim.sizeInMapNode.width / frameAnim.origSize.width, frameAnim.sizeInMapNode.height / frameAnim.origSize.height);\r\n      animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\r\n      safelyAddChild(self.node, animNode);\r\n      setLocalZOrder(animNode, 5);\r\n      anim.addClip(frameAnim.animationClip, \"default\");\r\n      anim.play(\"default\");\r\n    }\r\n\r\n    self.barrierColliders = [];\r\n    for (let boundaryObj of boundaryObjs.barriers) {\r\n      const newBarrier = cc.instantiate(self.barrierPrefab);\r\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\r\n      newBarrier.setPosition(newBoundaryOffsetInMapNode);\r\n      newBarrier.setAnchorPoint(cc.v2(0, 0));\r\n      const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider);\r\n      newBarrierColliderIns.points = [];\r\n      for (let p of boundaryObj) {\r\n        newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\r\n      }\r\n      self.barrierColliders.push(newBarrierColliderIns);\r\n      self.node.addChild(newBarrier);\r\n    }\r\n    const allLayers = tiledMapIns.getLayers();\r\n    for (let layer of allLayers) {\r\n      const layerType = layer.getProperty(\"type\");\r\n      switch (layerType) {\r\n        case \"normal\":\r\n          setLocalZOrder(layer.node, 0);\r\n          break;\r\n        case \"barrier_and_shelter\":\r\n          setLocalZOrder(layer.node, 3);\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n\r\n    const allObjectGroups = tiledMapIns.getObjectGroups();\r\n    for (let objectGroup of allObjectGroups) {\r\n      const objectGroupType = objectGroup.getProperty(\"type\");\r\n      switch (objectGroupType) {\r\n        case \"barrier_and_shelter\":\r\n          setLocalZOrder(objectGroup.node, 3);\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    }\r\n\r\n    for (let boundaryObj of boundaryObjs.sheltersZReducer) {\r\n      const newShelter = cc.instantiate(self.shelterZReducerPrefab);\r\n      const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\r\n      newShelter.setPosition(newBoundaryOffsetInMapNode);\r\n      newShelter.setAnchorPoint(cc.v2(0, 0));\r\n      const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider);\r\n      newShelterColliderIns.points = [];\r\n      for (let p of boundaryObj) {\r\n        newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\r\n      }\r\n      self.node.addChild(newShelter);\r\n    }\r\n\r\n    window.handleClientSessionCloseOrError = function() {\r\n      let shouldReconnectState = parseInt(cc.sys.localStorage.shouldReconnectState);\r\n      switch (shouldReconnectState) {\r\n        case 2:\r\n          shouldReconnectState = 1;\r\n          cc.sys.localStorage.shouldReconnectState = shouldReconnectState;\r\n          cc.log(\"Reconnecting because 2 == shouldReconnectState and it's now set to 1.\");\r\n          window.initPersistentSessionClient(self.initAfterWSConncted);\r\n          return;\r\n        case 1:\r\n          cc.log(\"Neither reconnecting nor alerting because 1 == shouldReconnectState and it's now removed.\");\r\n          cc.sys.localStorage.removeItem(\"shouldReconnectState\");\r\n          return;\r\n        default:\r\n          break;\r\n      }\r\n      if (null == self.battleState || ALL_BATTLE_STATES.WAITING == self.battleState) {\r\n        self.alertForGoingBackToLoginScene(\"Client session closed unexpectedly!\", self, true);\r\n      }\r\n    };\r\n\r\n    self.initAfterWSConncted = () => {\r\n      self.selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\r\n      Object.assign(self.selfPlayerInfo, {\r\n        id: self.selfPlayerInfo.playerId\r\n      });\r\n      self.transitToState(ALL_MAP_STATES.VISUAL);\r\n      self._inputControlEnabled = false;\r\n      self.setupInputControls();\r\n\r\n      window.handleRoomDownsyncFrame = function(diffFrame) {\r\n        if (ALL_BATTLE_STATES.WAITING != self.battleState && ALL_BATTLE_STATES.IN_BATTLE != self.battleState && ALL_BATTLE_STATES.IN_SETTLEMENT != self.battleState) return;\r\n        const refFrameId = diffFrame.refFrameId;\r\n        if (0 > refFrameId) {\r\n          cc.log(diffFrame.players)\r\n          cc.log(refFrameId)\r\n        }\r\n        if (-99 == refFrameId) { //\r\n          self.matchPlayersFinsihed(diffFrame.players);\r\n        } else if (-98 == refFrameId) { //\r\n          const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n          if (!self.findingPlayerNode.parent) {\r\n            self.showPopopInCanvas(self.findingPlayerNode);\r\n          }\r\n          findingPlayerScriptIns.updatePlayersInfo(diffFrame.players);\r\n          return;\r\n        }\r\n        const frameId = diffFrame.id;\r\n        if (frameId <= self.lastRoomDownsyncFrameId) {\r\n          // Log the obsolete frames?\r\n          return;\r\n        }\r\n        const isInitiatingFrame = (0 > self.recentFrameCacheCurrentSize || 0 == refFrameId);\r\n        /*\r\n        if (frameId % 300 == 0) {\r\n          // WARNING: For testing only!\r\n          if (0 < frameId) {\r\n            self._lazilyTriggerResync(); \r\n          }\r\n          cc.log(`${JSON.stringify(diffFrame)}`);\r\n        }\r\n        */\r\n        const cachedFullFrame = self.recentFrameCache[refFrameId];\r\n        if (\r\n          !isInitiatingFrame\r\n          && self.useDiffFrameAlgo\r\n          && (refFrameId > 0 || 0 < self.recentFrameCacheCurrentSize) // Critical condition to differentiate between \"BattleStarted\" or \"ShouldResync\". \r\n          && null == cachedFullFrame\r\n        ) {\r\n          self._lazilyTriggerResync();\r\n          // Later incoming diffFrames will all suffice that `0 < self.recentFrameCacheCurrentSize && null == cachedFullFrame`, until `this._onResyncCompleted` is successfully invoked.\r\n          return;\r\n        }\r\n\r\n        if (isInitiatingFrame && 0 == refFrameId) {\r\n          // Reaching here implies that you've received the resync frame.\r\n          self._onResyncCompleted();\r\n        }\r\n        let countdownNanos = diffFrame.countdownNanos;\r\n        if (countdownNanos < 0)\r\n          countdownNanos = 0;\r\n        const countdownSeconds = parseInt(countdownNanos / 1000000000);\r\n        if (isNaN(countdownSeconds)) {\r\n          cc.log(`countdownSeconds is NaN for countdownNanos == ${countdownNanos}.`);\r\n        }\r\n        self.countdownLabel.string = countdownSeconds;\r\n        const roomDownsyncFrame = (\r\n        (isInitiatingFrame || !self.useDiffFrameAlgo)\r\n          ?\r\n          diffFrame\r\n          :\r\n          self._generateNewFullFrame(cachedFullFrame, diffFrame)\r\n        );\r\n        if (countdownNanos <= 0) {\r\n          self.onBattleStopped(roomDownsyncFrame.players);\r\n          return;\r\n        }\r\n        self._dumpToFullFrameCache(roomDownsyncFrame);\r\n        const sentAt = roomDownsyncFrame.sentAt;\r\n        const players = roomDownsyncFrame.players;\r\n        const playerIdStrList = Object.keys(players);\r\n        self.otherPlayerCachedDataDict = {};\r\n        for (let i = 0; i < playerIdStrList.length; ++i) {\r\n          const k = playerIdStrList[i];\r\n          const playerId = parseInt(k);\r\n          if (playerId == self.selfPlayerInfo.id) {\r\n            const immediateSelfPlayerInfo = players[k];\r\n            Object.assign(self.selfPlayerInfo, {\r\n              x: immediateSelfPlayerInfo.x,\r\n              y: immediateSelfPlayerInfo.y,\r\n              speed: immediateSelfPlayerInfo.speed,\r\n              battleState: immediateSelfPlayerInfo.battleState,\r\n              score: immediateSelfPlayerInfo.score,\r\n              joinIndex: immediateSelfPlayerInfo.joinIndex,\r\n            });\r\n            continue;\r\n          }\r\n          const anotherPlayer = players[k];\r\n          // Note that this callback is invoked in the NetworkThread, and the rendering should be executed in the GUIThread, e.g. within `update(dt)`.\r\n          self.otherPlayerCachedDataDict[playerId] = anotherPlayer;\r\n        }\r\n        self.treasureInfoDict = {};\r\n        const treasures = roomDownsyncFrame.treasures;\r\n        const treasuresLocalIdStrList = Object.keys(treasures);\r\n        for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\r\n          const k = treasuresLocalIdStrList[i];\r\n          const treasureLocalIdInBattle = parseInt(k);\r\n          const treasureInfo = treasures[k];\r\n          self.treasureInfoDict[treasureLocalIdInBattle] = treasureInfo;\r\n        }\r\n\r\n        self.trapInfoDict = {};\r\n        const traps = roomDownsyncFrame.traps;\r\n        const trapsLocalIdStrList = Object.keys(traps);\r\n        for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\r\n          const k = trapsLocalIdStrList[i];\r\n          const trapLocalIdInBattle = parseInt(k);\r\n          const trapInfo = traps[k];\r\n          self.trapInfoDict[trapLocalIdInBattle] = trapInfo;\r\n        }\r\n\r\n        self.trapBulletInfoDict = {};\r\n        const bullets = roomDownsyncFrame.bullets;\r\n        const bulletsLocalIdStrList = Object.keys(bullets);\r\n        for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\r\n          const k = bulletsLocalIdStrList[i];\r\n          const bulletLocalIdInBattle = parseInt(k);\r\n          const bulletInfo = bullets[k];\r\n          self.trapBulletInfoDict[bulletLocalIdInBattle] = bulletInfo;\r\n        }\r\n\r\n        if (0 == self.lastRoomDownsyncFrameId) {\r\n          self.battleState = ALL_BATTLE_STATES.IN_BATTLE;\r\n          if (1 == frameId) {\r\n            // No need to prompt upon rejoined.\r\n            self.popupSimplePressToGo(\"Battle started!\");\r\n          }\r\n          self.onBattleStarted();\r\n        }\r\n        self.lastRoomDownsyncFrameId = frameId;\r\n      // TODO: Inject a NetworkDoctor as introduced in https://app.yinxiang.com/shard/s61/nl/13267014/5c575124-01db-419b-9c02-ec81f78c6ddc/.\r\n      };\r\n    }\r\n  },\r\n\r\n  setupInputControls() {\r\n    const instance = this;\r\n    const mapNode = instance.node;\r\n    const canvasNode = mapNode.parent;\r\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\r\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\r\n\r\n    const ctrl = joystickInputControllerScriptIns;\r\n    instance.ctrl = ctrl;\r\n\r\n    instance.inputControlTimer = setInterval(function() {\r\n      if (false == instance._inputControlEnabled) return;\r\n      instance.selfPlayerScriptIns.activeDirection = ctrl.activeDirection;\r\n    }, inputControlPollerMillis);\r\n  },\r\n\r\n  enableInputControls() {\r\n    this._inputControlEnabled = true;\r\n  },\r\n\r\n  disableInputControls() {\r\n    this._inputControlEnabled = false;\r\n  },\r\n\r\n  onBattleStarted() {\r\n    const self = this;\r\n    const canvasNode = self.canvasNode;\r\n    self.spawnSelfPlayer();\r\n    self.upsyncLoopInterval = setInterval(self._onPerUpsyncFrame.bind(self), self.clientUpsyncFps);\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    self.enableInputControls();\r\n    if (self.countdownToBeginGameNode.parent) {\r\n      self.countdownToBeginGameNode.parent.removeChild(self.countdownToBeginGameNode);\r\n      self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    }\r\n  },\r\n\r\n  onBattleStopped(players) {\r\n    const self = this;\r\n    const canvasNode = self.canvasNode;\r\n    const resultPanelNode = self.resultPanelNode;\r\n    const resultPanelScriptIns = resultPanelNode.getComponent(\"ResultPanel\");\r\n    resultPanelScriptIns.showPlayerInfo(players);\r\n    window.clearBoundRoomIdInBothVolatileAndPersistentStorage(); //cached boundRoomId\r\n    // Such that it doesn't execute \"update(dt)\" anymore. \r\n    self.selfPlayerNode.active = false;\r\n    self.battleState = ALL_BATTLE_STATES.IN_SETTLEMENT;\r\n    self.showPopopInCanvas(resultPanelNode);\r\n  },\r\n\r\n  spawnSelfPlayer() {\r\n    const instance = this;\r\n    const joinIndex = this.selfPlayerInfo.joinIndex;\r\n    const newPlayerNode = this.playersNode[joinIndex];\r\n    const tiledMapIns = instance.node.getComponent(cc.TiledMap);\r\n    let toStartWithPos = cc.v2(instance.selfPlayerInfo.x, instance.selfPlayerInfo.y)\r\n    newPlayerNode.setPosition(toStartWithPos);\r\n    newPlayerNode.getComponent(\"SelfPlayer\").mapNode = instance.node;\r\n\r\n    instance.node.addChild(newPlayerNode);\r\n    instance.selfPlayerScriptIns = newPlayerNode.getComponent(\"SelfPlayer\");\r\n    instance.selfPlayerScriptIns.showArrowTipNode();\r\n\r\n    setLocalZOrder(newPlayerNode, 5);\r\n    instance.selfPlayerNode = newPlayerNode;\r\n  },\r\n\r\n  update(dt) {\r\n    const self = this;\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    const canvasParentNode = canvasNode.parent;\r\n    if (null != window.boundRoomId) {\r\n      self.boundRoomIdLabel.string = window.boundRoomId;\r\n    }\r\n    if (null != self.selfPlayerInfo) {\r\n      const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\r\n      playersScriptIns.updateData(self.selfPlayerInfo);\r\n      if (null != self.selfPlayerScriptIns) {\r\n        self.selfPlayerScriptIns.updateSpeed(self.selfPlayerInfo.speed);\r\n      }\r\n    }\r\n\r\n    let toRemovePlayerNodeDict = {};\r\n    Object.assign(toRemovePlayerNodeDict, self.otherPlayerNodeDict);\r\n\r\n    let toRemoveTreasureNodeDict = {};\r\n    Object.assign(toRemoveTreasureNodeDict, self.treasureNodeDict);\r\n\r\n    let toRemoveTrapNodeDict = {};\r\n    Object.assign(toRemoveTrapNodeDict, self.trapNodeDict);\r\n\r\n    /*\r\n    * NOTE: At the beginning of each GUI update cycle, mark all `self.trapBulletNode` as `toRemoveBulletNode`, while only those that persist in `self.trapBulletInfoDict` are NOT finally removed. This approach aims to reduce the lines of codes for coping with node removal in the RoomDownsyncFrame algorithm.\r\n    */\r\n    let toRemoveBulletNodeDict = {};\r\n    Object.assign(toRemoveBulletNodeDict, self.trapBulletNodeDict);\r\n\r\n    for (let k in self.otherPlayerCachedDataDict) {\r\n      const playerId = parseInt(k);\r\n      const cachedPlayerData = self.otherPlayerCachedDataDict[playerId];\r\n      const newPos = cc.v2(\r\n        cachedPlayerData.x,\r\n        cachedPlayerData.y\r\n      );\r\n      //\r\n      if (null != cachedPlayerData) {\r\n        const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\r\n        playersScriptIns.updateData(cachedPlayerData);\r\n      }\r\n      let targetNode = self.otherPlayerNodeDict[playerId];\r\n      if (!targetNode) {\r\n        targetNode = self.playersNode[cachedPlayerData.joinIndex];\r\n        targetNode.getComponent(\"SelfPlayer\").mapNode = mapNode;\r\n        self.otherPlayerNodeDict[playerId] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n      const aControlledOtherPlayerScriptIns = targetNode.getComponent(\"SelfPlayer\");\r\n      aControlledOtherPlayerScriptIns.updateSpeed(cachedPlayerData.speed);\r\n\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y\r\n      );\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const toMoveByVecMag = toMoveByVec.mag();\r\n      const toTeleportDisThreshold = (cachedPlayerData.speed * dt * 100);\r\n      const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 0.5);\r\n      if (toMoveByVecMag < notToMoveDisThreshold) {\r\n        aControlledOtherPlayerScriptIns.activeDirection = {\r\n          dx: 0,\r\n          dy: 0\r\n        };\r\n      } else {\r\n        if (toMoveByVecMag > toTeleportDisThreshold) {\r\n          cc.log(`Player ${cachedPlayerData.id} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\r\n          aControlledOtherPlayerScriptIns.activeDirection = {\r\n            dx: 0,\r\n            dy: 0\r\n          };\r\n          // TODO: Use `cc.Action`?\r\n          targetNode.setPosition(newPos);\r\n        } else {\r\n          // The common case which is suitable for interpolation.\r\n          const normalizedDir = {\r\n            dx: toMoveByVec.x / toMoveByVecMag,\r\n            dy: toMoveByVec.y / toMoveByVecMag,\r\n          };\r\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\r\n            aControlledOtherPlayerScriptIns.activeDirection = {\r\n              dx: 0,\r\n              dy: 0,\r\n            };\r\n          } else {\r\n            aControlledOtherPlayerScriptIns.activeDirection = normalizedDir;\r\n          } \r\n        }\r\n      }\r\n\r\n      if (0 != cachedPlayerData.dir.dx || 0 != cachedPlayerData.dir.dy) {\r\n        const newScheduledDirection = self.ctrl.discretizeDirection(cachedPlayerData.dir.dx, cachedPlayerData.dir.dy, self.ctrl.joyStickEps);\r\n        aControlledOtherPlayerScriptIns.scheduleNewDirection(newScheduledDirection, false /* DON'T interrupt playing anim. */ );\r\n      }\r\n\r\n      if (null != toRemovePlayerNodeDict[playerId]) {\r\n        delete toRemovePlayerNodeDict[playerId];\r\n      }\r\n    }\r\n\r\n    //  \r\n    for (let k in self.trapInfoDict) {\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      const trapInfo = self.trapInfoDict[trapLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        trapInfo.x,\r\n        trapInfo.y\r\n      );\r\n      let targetNode = self.trapNodeDict[trapLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.trapPrefab);\r\n        self.trapNodeDict[trapLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n      if (null != toRemoveTrapNodeDict[trapLocalIdInBattle]) {\r\n        delete toRemoveTrapNodeDict[trapLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    // bullet \r\n    for (let k in self.trapBulletInfoDict) {\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      const bulletInfo = self.trapBulletInfoDict[bulletLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        bulletInfo.x,\r\n        bulletInfo.y\r\n      );\r\n      let targetNode = self.trapBulletNodeDict[bulletLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.trapBulletPrefab);\r\n        self.trapBulletNodeDict[bulletLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      } \r\n      const aBulletScriptIns = targetNode.getComponent(\"Bullet\"); \r\n      aBulletScriptIns.localIdInBattle = bulletLocalIdInBattle;\r\n      aBulletScriptIns.linearSpeed = bulletInfo.linearSpeed * 1000000000; // The `bullet.LinearSpeed` on server-side is denoted in pts/nanoseconds. \r\n\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y,\r\n      );\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const toMoveByVecMag = toMoveByVec.mag();\r\n      const toTeleportDisThreshold = (aBulletScriptIns.linearSpeed * dt * 100);\r\n      const notToMoveDisThreshold = (aBulletScriptIns.linearSpeed * dt * 0.5);\r\n      if (toMoveByVecMag < notToMoveDisThreshold) {\r\n        aBulletScriptIns.activeDirection = {\r\n          dx: 0,\r\n          dy: 0,\r\n        };\r\n      } else {\r\n        if (toMoveByVecMag > toTeleportDisThreshold) {\r\n          cc.log(`Bullet ${bulletLocalIdInBattle} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\r\n          aBulletScriptIns.activeDirection = {\r\n            dx: 0,\r\n            dy: 0\r\n          };\r\n          // TODO: Use `cc.Action`?\r\n          targetNode.setPosition(newPos);\r\n        } else {\r\n          // The common case which is suitable for interpolation.\r\n          const normalizedDir = {\r\n            dx: toMoveByVec.x / toMoveByVecMag,\r\n            dy: toMoveByVec.y / toMoveByVecMag,\r\n          };\r\n          if (isNaN(normalizedDir.dx) || isNaN(normalizedDir.dy)) {\r\n            aBulletScriptIns.activeDirection = {\r\n              dx: 0,\r\n              dy: 0,\r\n            };\r\n          } else {\r\n            aBulletScriptIns.activeDirection = normalizedDir;\r\n          } \r\n        }\r\n      }\r\n      if (null != toRemoveBulletNodeDict[bulletLocalIdInBattle]) {\r\n        delete toRemoveBulletNodeDict[bulletLocalIdInBattle];\r\n      }\r\n    }\r\n\r\n    //  \r\n    for (let k in self.treasureInfoDict) {\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      const treasureInfo = self.treasureInfoDict[treasureLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        treasureInfo.x,\r\n        treasureInfo.y\r\n      );\r\n      let targetNode = self.treasureNodeDict[treasureLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.treasurePrefab);\r\n        const treasureNodeScriptIns = targetNode.getComponent(\"Treasure\");\r\n        treasureNodeScriptIns.setData(treasureInfo);\r\n        self.treasureNodeDict[treasureLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n\r\n      if (null != toRemoveTreasureNodeDict[treasureLocalIdInBattle]) {\r\n        delete toRemoveTreasureNodeDict[treasureLocalIdInBattle];\r\n      }\r\n      if (0 < targetNode.getNumberOfRunningActions()) {\r\n        // A significant trick to smooth the position sync performance!\r\n        continue;\r\n      }\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y\r\n      );\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const durationSeconds = dt; // Using `dt` temporarily!\r\n      targetNode.runAction(cc.moveTo(durationSeconds, newPos));\r\n    }\r\n\r\n    // Coping with removed players.\r\n    for (let k in toRemovePlayerNodeDict) {\r\n      const playerId = parseInt(k);\r\n      toRemovePlayerNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\r\n      delete self.otherPlayerNodeDict[playerId];\r\n    }\r\n\r\n    // Coping with removed treasures.\r\n    for (let k in toRemoveTreasureNodeDict) {\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      const treasureScriptIns = toRemoveTreasureNodeDict[k].getComponent(\"Treasure\");\r\n      treasureScriptIns.playPickedUpAnimAndDestroy();\r\n      delete self.treasureNodeDict[treasureLocalIdInBattle];\r\n    }\r\n\r\n    // Coping with removed traps.\r\n    for (let k in toRemoveTrapNodeDict) {\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      toRemoveTrapNodeDict[k].parent.removeChild(toRemoveTrapNodeDict[k]);\r\n      delete self.trapNodeDict[trapLocalIdInBattle];\r\n    }\r\n\r\n    // Coping with removed bullets.\r\n    for (let k in toRemoveBulletNodeDict) {\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      toRemoveBulletNodeDict[k].parent.removeChild(toRemoveBulletNodeDict[k]);\r\n      delete self.trapBulletNodeDict[bulletLocalIdInBattle];\r\n    }\r\n  },\r\n\r\n  transitToState(s) {\r\n    const self = this;\r\n    self.state = s;\r\n  },\r\n\r\n  logout(byClick /* The case where this param is \"true\" will be triggered within `ConfirmLogout.js`.*/ , shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    const localClearance = function() {\r\n      window.closeWSConnection();\r\n      if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n      }\r\n      cc.sys.localStorage.removeItem('selfPlayer');\r\n      cc.director.loadScene('login');\r\n    };\r\n\r\n    const self = this;\r\n    if (null != cc.sys.localStorage.selfPlayer) {\r\n      const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\r\n      const requestContent = {\r\n        intAuthToken: selfPlayer.intAuthToken\r\n      }\r\n      try {\r\n        NetworkUtils.ajax({\r\n          url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\r\n          type: \"POST\",\r\n          data: requestContent,\r\n          success: function(res) {\r\n            if (res.ret != constants.RET_CODE.OK) {\r\n              cc.log(`Logout failed: ${res}.`);\r\n            }\r\n            localClearance();\r\n          },\r\n          error: function(xhr, status, errMsg) {\r\n            localClearance();\r\n          },\r\n          timeout: function() {\r\n            localClearance();\r\n          }\r\n        });\r\n      } catch (e) {} finally {\r\n        // For Safari (both desktop and mobile).\r\n        localClearance();\r\n      }\r\n    } else {\r\n      localClearance();\r\n    }\r\n  },\r\n\r\n  onLogoutClicked(evt) {\r\n    const self = this;\r\n    self.showPopopInCanvas(self.confirmLogoutNode);\r\n  },\r\n\r\n  onLogoutConfirmationDismissed() {\r\n    const self = this;\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    const canvasNode = self.canvasNode;\r\n    canvasNode.removeChild(self.confirmLogoutNode);\r\n    self.enableInputControls();\r\n  },\r\n\r\n  initWSConnection(evt, cb) {\r\n    const self = this;\r\n    window.initPersistentSessionClient(self.initAfterWSConncted);\r\n    if (cb) {\r\n      cb()\r\n    }\r\n  },\r\n\r\n  showPopopInCanvas(toShowNode) {\r\n    const self = this;\r\n    self.disableInputControls();\r\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\r\n    safelyAddChild(self.widgetsAboveAllNode, toShowNode);\r\n    setLocalZOrder(toShowNode, 10);\r\n  },\r\n\r\n  matchPlayersFinsihed(players) {\r\n    const self = this;\r\n    const findingPlayerScriptIns = self.findingPlayerNode.getComponent(\"FindingPlayer\");\r\n    findingPlayerScriptIns.updatePlayersInfo(players);\r\n    window.setTimeout(() => {\r\n      if (self.findingPlayerNode.parent) {\r\n        self.findingPlayerNode.parent.removeChild(self.findingPlayerNode);\r\n        self.transitToState(ALL_MAP_STATES.VISUAL);\r\n        for (let i in players) {\r\n          //\r\n          const playerInfo = players[i];\r\n          const playersScriptIns = self.playersInfoNode.getComponent(\"PlayersInfo\");\r\n          playersScriptIns.updateData(playerInfo);\r\n        }\r\n      }\r\n      const countDownScriptIns = self.countdownToBeginGameNode.getComponent(\"CountdownToBeginGame\"); \r\n      countDownScriptIns.setData();\r\n      self.showPopopInCanvas(self.countdownToBeginGameNode);\r\n      return;\r\n    }, 2000);\r\n  },\r\n});\r\n"]}