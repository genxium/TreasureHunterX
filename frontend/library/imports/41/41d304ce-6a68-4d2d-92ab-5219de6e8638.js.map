{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\Map.js"],"names":["i18n","require","init","window","language","ALL_MAP_STATES","VISUAL","EDITING_BELONGING","SHOWING_MODAL_POPUP","ALL_BATTLE_STATES","WAITING","IN_BATTLE","IN_SETTLEMENT","IN_DISMISSAL","cc","Class","extends","Component","properties","useDiffFrameAlgo","default","canvasNode","type","Node","tiledAnimPrefab","Prefab","selfPlayerPrefab","treasurePrefab","trapPrefab","npcPlayerPrefab","type2NpcPlayerPrefab","barrierPrefab","shelterPrefab","shelterZReducerPrefab","keyboardInputControllerNode","joystickInputControllerNode","confirmLogoutPrefab","simplePressToGoDialogPrefab","selfPlayerIdLabel","Label","boundRoomIdLabel","countdownLabel","selfPlayerScoreLabel","otherPlayerScoreIndicatorPrefab","trapBulletPrefab","resultPanelPrefab","gameRulePrefab","findingPlayerPrefab","_generateNewFullFrame","refFullFrame","diffFrame","newFullFrame","id","treasures","traps","bullets","players","playersLocalIdStrList","Object","keys","i","length","k","playerId","parseInt","removed","treasuresLocalIdStrList","treasureLocalIdInBattle","trapsLocalIdStrList","trapLocalIdInBattle","bulletsLocalIdStrList","bulletLocalIdInBattle","_dumpToFullFrameCache","fullFrame","self","recentFrameCacheCurrentSize","recentFrameCacheMaxCount","toDelFrameId","recentFrameCache","_onPerUpsyncFrame","instance","selfPlayerInfo","selfPlayerScriptIns","scheduledDirection","upsyncFrameData","dir","dx","parseFloat","dy","x","selfPlayerNode","y","ackingFrameId","lastRoomDownsyncFrameId","wrapped","msgId","Date","now","act","data","sendSafely","JSON","stringify","onDestroy","upsyncLoopInterval","clearInterval","inputControlTimer","popupSimplePressToGo","labelString","state","simplePressToGoDialogNode","instantiate","setPosition","v2","setScale","getScale","simplePressToGoDialogScriptIns","getComponent","yesButton","getChildByName","postDismissalByYes","transitToState","removeChild","string","once","dismissDialog","bind","safelyAddChild","widgetsAboveAllNode","setLocalZOrder","alertForGoingBackToLoginScene","mapIns","shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage","millisToGo","js","formatStr","setTimeout","logout","onLoad","mapNode","node","parent","director","getCollisionManager","enabled","enabledDebugDraw","CC_DEBUG","mainCameraNode","mainCamera","Camera","children","child","zoomRatio","battleState","otherPlayerCachedDataDict","otherPlayerNodeDict","treasureInfoDict","treasureNodeDict","trapInfoDict","trapBulletInfoDict","trapBulletNodeDict","trapNodeDict","scoreInfoDict","confirmLogoutNode","resultPanelNode","gameRuleNode","gameRuleScriptIns","showPopopInCanvas","findingPlayerNode","clientUpsyncFps","reconnectWSWithoutRoomId","Promise","resolve","reject","clientSessionPingInterval","clearBoundRoomIdInBothVolatileAndPersistentStorage","then","initPersistentSessionClient","initAfterWSConncted","handleClientSessionCloseOrError","tiledMapIns","TiledMap","parse","sys","localStorage","selfPlayer","assign","_inputControlEnabled","setupInputControls","boundaryObjs","tileCollisionManager","extractBoundaryObjects","frameAnimations","frameAnim","animNode","anim","Animation","posInMapNode","width","sizeInMapNode","height","origSize","setAnchorPoint","addClip","animationClip","play","barrierColliders","barriers","boundaryObj","newBarrier","newBoundaryOffsetInMapNode","newBarrierColliderIns","PolygonCollider","points","p","push","sub","addChild","allLayers","getLayers","layer","layerType","getProperty","allObjectGroups","getObjectGroups","objectGroup","objectGroupType","sheltersZReducer","newShelter","newShelterColliderIns","handleRoomDownsyncFrame","frameId","refFrameId","isInitiatingFrame","log","cachedFullFrame","countdownNanos","countdownSeconds","isNaN","roomDownsyncFrame","onBattleStopped","sentAt","playerIdStrList","immediateSelfPlayerInfo","speed","score","anotherPlayer","treasureInfo","trapInfo","bulletInfo","onBattleStarted","joystickInputControllerScriptIns","inputControlPollerMillis","pollerFps","ctrl","setInterval","activeDirection","enableInputControls","disableInputControls","spawnSelfPlayer","resultPanelScriptIns","showPlayerInfo","active","newPlayerNode","toStartWithPos","update","dt","canvasParentNode","boundRoomId","updateSpeed","toRemovePlayerNodeDict","toRemoveTreasureNodeDict","toRemoveTrapNodeDict","toRemoveBulletNodeDict","cachedPlayerData","newPos","scoreNode","debugInfoNode","playerScore","targetNode","aControlledOtherPlayerScriptIns","newScheduledDirection","discretizeDirection","joyStickEps","scheduleNewDirection","oldPos","toMoveByVec","toMoveByVecMag","mag","toTeleportDisThreshold","notToMoveDisThreshold","normalizedDir","getNumberOfRunningActions","durationSeconds","runAction","moveTo","s","byClick","localClearance","closeWSConnection","removeItem","loadScene","requestContent","intAuthToken","NetworkUtils","ajax","url","backendAddress","PROTOCOL","HOST","PORT","constants","ROUTE_PATH","API","PLAYER","VERSION","INT_AUTH_TOKEN","LOGOUT","success","res","ret","RET_CODE","OK","error","xhr","status","errMsg","timeout","e","onLogoutClicked","evt","onLogoutConfirmationDismissed","initWSConnection","cb","toShowNode"],"mappings":"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","file":"Map.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["const i18n = require('LanguageData');\r\ni18n.init(window.language); // languageID should be equal to the one we input in New Language ID input field\r\n\r\nwindow.ALL_MAP_STATES = {\r\n  VISUAL: 0, // For free dragging & zooming.\r\n  EDITING_BELONGING: 1,\r\n  SHOWING_MODAL_POPUP: 2,\r\n};\r\n\r\nwindow.ALL_BATTLE_STATES = {\r\n  WAITING: 0,\r\n  IN_BATTLE: 1,\r\n  IN_SETTLEMENT: 2,\r\n  IN_DISMISSAL: 3,\r\n};\r\n\r\ncc.Class({\r\n  extends: cc.Component,\r\n\r\n  properties: { \r\n    useDiffFrameAlgo: {\r\n      default: true \r\n    },\r\n    canvasNode: {\r\n      type: cc.Node,\r\n      default: null,\r\n    },\r\n    tiledAnimPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    selfPlayerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    treasurePrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    trapPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    npcPlayerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    type2NpcPlayerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    barrierPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    shelterPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    shelterZReducerPrefab: {\r\n      type: cc.Prefab,\r\n      default: null,\r\n    },\r\n    keyboardInputControllerNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    joystickInputControllerNode: {\r\n      type: cc.Node,\r\n      default: null\r\n    },\r\n    confirmLogoutPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    simplePressToGoDialogPrefab: {\r\n      type: cc.Prefab,\r\n      default: null\r\n    },\r\n    selfPlayerIdLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    boundRoomIdLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    countdownLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    selfPlayerScoreLabel: {\r\n      type: cc.Label,\r\n      default: null\r\n    },\r\n    otherPlayerScoreIndicatorPrefab: {\r\n      type:cc.Prefab,\r\n      default: null\r\n    },\r\n    trapBulletPrefab: {\r\n      type:cc.Prefab,\r\n      default: null\r\n    },\r\n    resultPanelPrefab: {\r\n      type:cc.Prefab,\r\n      default: null\r\n    },\r\n    gameRulePrefab: {\r\n      type:cc.Prefab,\r\n      default: null\r\n    },\r\n    findingPlayerPrefab: {\r\n      type:cc.Prefab,\r\n      default: null\r\n    },\r\n  },\r\n  \r\n  _generateNewFullFrame: function(refFullFrame, diffFrame) {\r\n    let newFullFrame = {\r\n      id: diffFrame.id,\r\n      treasures: refFullFrame.treasures,\r\n      traps: refFullFrame.traps,\r\n      bullets: refFullFrame.bullets,\r\n      players: refFullFrame.players,\r\n    };\r\n\r\n    const players = diffFrame.players;\r\n    const playersLocalIdStrList = Object.keys(players);\r\n    for (let i = 0; i < playersLocalIdStrList.length; ++i) {\r\n      const k = playersLocalIdStrList[i];\r\n      const playerId = parseInt(k);\r\n      if (true == diffFrame.players[playerId].removed) {\r\n        // cc.log(`Player id == ${playerId} is removed.`);\r\n        delete newFullFrame.players[playerId];\r\n      } else {\r\n        newFullFrame.players[playerId] = diffFrame.players[playerId];  \r\n      }  \r\n    }\r\n    \r\n    const treasures = diffFrame.treasures;\r\n    const treasuresLocalIdStrList = Object.keys(treasures);\r\n    for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\r\n      const k = treasuresLocalIdStrList[i];\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.treasures[treasureLocalIdInBattle].removed) {\r\n        // cc.log(`Treasure with localIdInBattle == ${treasureLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.treasures[treasureLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.treasures[treasureLocalIdInBattle] = diffFrame.treasures[treasureLocalIdInBattle];  \r\n      }  \r\n    }\r\n\r\n    const traps = diffFrame.traps;\r\n    const trapsLocalIdStrList = Object.keys(traps);\r\n    for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\r\n      const k = trapsLocalIdStrList[i];\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.traps[trapLocalIdInBattle].removed) {\r\n        // cc.log(`Trap with localIdInBattle == ${trapLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.traps[trapLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.traps[trapLocalIdInBattle] = diffFrame.traps[trapLocalIdInBattle];  \r\n      }\r\n    }\r\n\r\n    const bullets = diffFrame.bullets;\r\n    const bulletsLocalIdStrList = Object.keys(bullets);\r\n    for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\r\n      const k = bulletsLocalIdStrList[i];\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      if (true == diffFrame.bullets[bulletLocalIdInBattle].removed) {\r\n        // cc.log(`Bullet with localIdInBattle == ${bulletLocalIdInBattle} is removed.`);\r\n        delete newFullFrame.bullets[bulletLocalIdInBattle];\r\n      } else {\r\n        newFullFrame.bullets[bulletLocalIdInBattle] = diffFrame.bullets[bulletLocalIdInBattle];  \r\n      }\r\n    }\r\n\r\n    return newFullFrame;\r\n  },\r\n\r\n  _dumpToFullFrameCache: function(fullFrame) {\r\n    const self = this;\r\n    while (self.recentFrameCacheCurrentSize >= self.recentFrameCacheMaxCount) {\r\n      const toDelFrameId = Object.keys(self.recentFrameCache)[0];\r\n      // cc.log(\"toDelFrameId is \" + toDelFrameId + \".\");\r\n      delete self.recentFrameCache[toDelFrameId];\r\n      --self.recentFrameCacheCurrentSize;\r\n    }\r\n    self.recentFrameCache[fullFrame.id] = fullFrame;\r\n    ++self.recentFrameCacheCurrentSize;\r\n  },\r\n\r\n  _onPerUpsyncFrame() {\r\n    const instance = this;\r\n    if (\r\n      null == instance.selfPlayerInfo ||\r\n      null == instance.selfPlayerScriptIns ||\r\n      null == instance.selfPlayerScriptIns.scheduledDirection\r\n      ) return;\r\n    const upsyncFrameData = {\r\n      id: instance.selfPlayerInfo.id,\r\n      /**\r\n      * WARNING\r\n      *\r\n      * Deliberately NOT upsyncing the `instance.selfPlayerScriptIns.activeDirection` here, because it'll be deduced by other players from the position differences of `RoomDownsyncFrame`s.\r\n      */\r\n      dir: {\r\n        dx: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dx),\r\n        dy: parseFloat(instance.selfPlayerScriptIns.scheduledDirection.dy),\r\n      },\r\n      x: parseFloat(instance.selfPlayerNode.x),\r\n      y: parseFloat(instance.selfPlayerNode.y),\r\n      ackingFrameId: instance.lastRoomDownsyncFrameId,\r\n    };\r\n    const wrapped = {\r\n      msgId: Date.now(),\r\n      act: \"PlayerUpsyncCmd\",\r\n      data: upsyncFrameData,\r\n    }\r\n    window.sendSafely(JSON.stringify(wrapped));\r\n  },\r\n\r\n  // LIFE-CYCLE CALLBACKS:\r\n  onDestroy() {\r\n    const self = this;\r\n    if (self.upsyncLoopInterval) {\r\n      clearInterval(self.upsyncLoopInterval);\r\n    }\r\n    if (self.inputControlTimer) {\r\n      clearInterval(self.inputControlTimer)\r\n    }\r\n  },\r\n\r\n  popupSimplePressToGo(labelString) {\r\n    const self = this;\r\n    /*\r\n    if (ALL_MAP_STATES.VISUAL != self.state) {\r\n      return;\r\n    }*/\r\n    self.state = ALL_MAP_STATES.SHOWING_MODAL_POPUP;\r\n\r\n    const canvasNode = self.canvasNode;\r\n    const simplePressToGoDialogNode = cc.instantiate(self.simplePressToGoDialogPrefab);\r\n    simplePressToGoDialogNode.setPosition(cc.v2(0, 0));\r\n    simplePressToGoDialogNode.setScale(1 / canvasNode.getScale());\r\n    const simplePressToGoDialogScriptIns = simplePressToGoDialogNode.getComponent(\"SimplePressToGoDialog\");\r\n    const yesButton = simplePressToGoDialogNode.getChildByName(\"Yes\");\r\n    const postDismissalByYes = () => {\r\n      self.transitToState(ALL_MAP_STATES.VISUAL);\r\n      canvasNode.removeChild(simplePressToGoDialogNode);\r\n    }\r\n    simplePressToGoDialogNode.getChildByName(\"Hint\").getComponent(cc.Label).string = labelString;\r\n    yesButton.once(\"click\", simplePressToGoDialogScriptIns.dismissDialog.bind(simplePressToGoDialogScriptIns, postDismissalByYes));\r\n    yesButton.getChildByName(\"Label\").getComponent(cc.Label).string = \"OK\";\r\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\r\n    safelyAddChild(self.widgetsAboveAllNode, simplePressToGoDialogNode);\r\n    setLocalZOrder(simplePressToGoDialogNode, 20);\r\n  },\r\n\r\n  alertForGoingBackToLoginScene(labelString, mapIns, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    const millisToGo = 3000;\r\n    mapIns.popupSimplePressToGo(cc.js.formatStr(\"%s will logout in %s seconds.\", labelString, millisToGo / 1000));\r\n    setTimeout(() => {\r\n      mapIns.logout(false, shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage);\r\n    }, millisToGo);\r\n },\r\n\r\n  onLoad() {\r\n    const self = this;\r\n    self.lastRoomDownsyncFrameId = 0;\r\n\r\n    self.recentFrameCache = {};\r\n    self.recentFrameCacheCurrentSize = 0;\r\n    self.recentFrameCacheMaxCount = 2048;\r\n\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    cc.director.getCollisionManager().enabled = true;\r\n    cc.director.getCollisionManager().enabledDebugDraw = CC_DEBUG;\r\n\r\n    self.mainCameraNode = canvasNode.getChildByName(\"Main Camera\");\r\n    self.mainCamera = self.mainCameraNode.getComponent(cc.Camera);\r\n    for (let child of self.mainCameraNode.children) {\r\n      child.setScale(1/self.mainCamera.zoomRatio); \r\n    } \r\n    self.widgetsAboveAllNode = self.mainCameraNode.getChildByName(\"WidgetsAboveAll\"); \r\n\r\n    self.selfPlayerNode = null;\r\n    self.selfPlayerScriptIns = null;\r\n    self.selfPlayerInfo = null;\r\n    self.upsyncLoopInterval = null;\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n\r\n    self.battleState = ALL_BATTLE_STATES.WAITING;\r\n    self.otherPlayerCachedDataDict = {};\r\n    self.otherPlayerNodeDict = {};\r\n    self.treasureInfoDict = {};\r\n    self.treasureNodeDict = {};\r\n    self.trapInfoDict = {};\r\n    self.trapBulletInfoDict = {};\r\n    self.trapBulletNodeDict = {};\r\n    self.trapNodeDict = {};\r\n    self.scoreInfoDict = {};\r\n\r\n    /** init confirmLogoutNode started */\r\n    self.confirmLogoutNode = cc.instantiate(self.confirmLogoutPrefab);\r\n    self.confirmLogoutNode.getComponent(\"ConfirmLogout\").mapNode = self.node;\r\n    /** init confirmLogoutNode ended */\r\n\r\n    /** init resultPanelNode started */\r\n    self.resultPanelNode = cc.instantiate(self.resultPanelPrefab);\r\n    /** init resultPanelNode ended */\r\n\r\n    /** init gameRuleNode started */\r\n    self.gameRuleNode = cc.instantiate(self.gameRulePrefab);\r\n    self.gameRuleScriptIns = self.gameRuleNode.getComponent(\"GameRule\");\r\n    self.gameRuleScriptIns.mapNode = self.node;\r\n    self.showPopopInCanvas(self.gameRuleNode);\r\n    /** init resultPanelNode ended */\r\n\r\n    /** init findingPlayer started */\r\n    self.findingPlayerNode = cc.instantiate(self.findingPlayerPrefab);\r\n    /** init findingPlayerNode ended */\r\n\r\n    self.clientUpsyncFps = 20;\r\n    self.upsyncLoopInterval = null;\r\n\r\n    window.reconnectWSWithoutRoomId = function() {\r\n      return  new Promise((resolve,reject) => {\r\n      if (window.clientSessionPingInterval) {\r\n        clearInterval(clientSessionPingInterval);\r\n      }\r\n      window.clearBoundRoomIdInBothVolatileAndPersistentStorage()\r\n      return resolve();\r\n      })\r\n      .then(() =>{\r\n        this.initPersistentSessionClient(this.initAfterWSConncted);\r\n      });\r\n    }\r\n\r\n    window.handleClientSessionCloseOrError = function() {\r\n      if(!self.battleState)\r\n        self.alertForGoingBackToLoginScene(\"Client session closed unexpectedly!\", self, true);\r\n    };\r\n\r\n    self.initAfterWSConncted = () => {\r\n      self.transitToState(ALL_MAP_STATES.VISUAL);\r\n      const tiledMapIns = self.node.getComponent(cc.TiledMap);\r\n      self.selfPlayerInfo = JSON.parse(cc.sys.localStorage.selfPlayer);\r\n      Object.assign(self.selfPlayerInfo, {\r\n        id: self.selfPlayerInfo.playerId\r\n      });\r\n      this._inputControlEnabled = false;\r\n      self.setupInputControls();\r\n\r\n      const boundaryObjs = tileCollisionManager.extractBoundaryObjects(self.node);\r\n      for (let frameAnim of boundaryObjs.frameAnimations) {\r\n        const animNode = cc.instantiate(self.tiledAnimPrefab);\r\n        const anim = animNode.getComponent(cc.Animation);\r\n        animNode.setPosition(frameAnim.posInMapNode);\r\n        animNode.width = frameAnim.sizeInMapNode.width;\r\n        animNode.height = frameAnim.sizeInMapNode.height;\r\n        animNode.setScale(frameAnim.sizeInMapNode.width / frameAnim.origSize.width, frameAnim.sizeInMapNode.height / frameAnim.origSize.height);\r\n        animNode.setAnchorPoint(cc.v2(0.5, 0)); // A special requirement for \"image-type Tiled object\" by \"CocosCreator v2.0.1\".\r\n        safelyAddChild(self.node, animNode);\r\n        setLocalZOrder(animNode, 5);\r\n        anim.addClip(frameAnim.animationClip, \"default\");\r\n        anim.play(\"default\");\r\n      }\r\n\r\n      self.barrierColliders = [];\r\n      for (let boundaryObj of boundaryObjs.barriers) {\r\n        const newBarrier = cc.instantiate(self.barrierPrefab);\r\n        const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\r\n        newBarrier.setPosition(newBoundaryOffsetInMapNode);\r\n        newBarrier.setAnchorPoint(cc.v2(0, 0));\r\n        const newBarrierColliderIns = newBarrier.getComponent(cc.PolygonCollider);\r\n        newBarrierColliderIns.points = [];\r\n        for (let p of boundaryObj) {\r\n          newBarrierColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\r\n        }\r\n        self.barrierColliders.push(newBarrierColliderIns);\r\n        self.node.addChild(newBarrier);\r\n      }\r\n\r\n      const allLayers = tiledMapIns.getLayers();\r\n      for (let layer of allLayers) {\r\n        const layerType = layer.getProperty(\"type\");\r\n        switch (layerType) {\r\n          case \"normal\":\r\n            setLocalZOrder(layer.node, 0);\r\n            break;\r\n          case \"barrier_and_shelter\":\r\n            setLocalZOrder(layer.node, 3);\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      }\r\n\r\n      const allObjectGroups = tiledMapIns.getObjectGroups();\r\n      for (let objectGroup of allObjectGroups) {\r\n        const objectGroupType = objectGroup.getProperty(\"type\");\r\n        switch (objectGroupType) {\r\n          case \"barrier_and_shelter\":\r\n            setLocalZOrder(objectGroup.node, 3);\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      }\r\n\r\n      for (let boundaryObj of boundaryObjs.sheltersZReducer) {\r\n        const newShelter = cc.instantiate(self.shelterZReducerPrefab);\r\n        const newBoundaryOffsetInMapNode = cc.v2(boundaryObj[0].x, boundaryObj[0].y);\r\n        newShelter.setPosition(newBoundaryOffsetInMapNode);\r\n        newShelter.setAnchorPoint(cc.v2(0, 0));\r\n        const newShelterColliderIns = newShelter.getComponent(cc.PolygonCollider);\r\n        newShelterColliderIns.points = [];\r\n        for (let p of boundaryObj) {\r\n          newShelterColliderIns.points.push(p.sub(newBoundaryOffsetInMapNode));\r\n        }\r\n        self.node.addChild(newShelter);\r\n      }\r\n\r\n      window.handleRoomDownsyncFrame = function(diffFrame) {\r\n        if (ALL_BATTLE_STATES.WAITING != self.battleState && ALL_BATTLE_STATES.IN_BATTLE != self.battleState && ALL_BATTLE_STATES.IN_SETTLEMENT != self.battleState) return;\r\n        const frameId = diffFrame.id;\r\n        if (frameId <= self.lastRoomDownsyncFrameId) {\r\n          // Log the obsolete frames?\r\n          return;\r\n        }\r\n        const refFrameId = diffFrame.refFrameId;\r\n        const isInitiatingFrame = (0 >= self.recentFrameCacheCurrentSize || 0 == refFrameId); \r\n        if (refFrameId % 60 == 0) {\r\n          cc.log(`${JSON.stringify(diffFrame)}`);\r\n        }\r\n        const cachedFullFrame = self.recentFrameCache[refFrameId];\r\n        if (!isInitiatingFrame && self.useDiffFrameAlgo && null == cachedFullFrame) {\r\n          cc.log(`Should send a reset upsync to server for diffFrame id == ${frameId}, refFrameId == ${refFrameId}`);\r\n          return;\r\n        } \r\n        let countdownNanos = diffFrame.countdownNanos;\r\n        if (countdownNanos < 0) countdownNanos = 0;\r\n        const countdownSeconds = parseInt(countdownNanos / 1000000000);\r\n        if (isNaN(countdownSeconds)) {\r\n          cc.log(`countdownSeconds is NaN for countdownNanos == ${countdownNanos}.`);\r\n        }\r\n        self.countdownLabel.string = countdownSeconds;\r\n        const roomDownsyncFrame = (\r\n          (isInitiatingFrame || !self.useDiffFrameAlgo)\r\n          ?\r\n          diffFrame    \r\n          :\r\n          self._generateNewFullFrame(cachedFullFrame, diffFrame) \r\n        ); \r\n        if (countdownNanos <= 0) {\r\n          self.onBattleStopped(roomDownsyncFrame.players);\r\n          return;\r\n        }\r\n        self._dumpToFullFrameCache(roomDownsyncFrame);\r\n        const sentAt = roomDownsyncFrame.sentAt;\r\n        const players = roomDownsyncFrame.players;\r\n        const playerIdStrList = Object.keys(players);\r\n        self.otherPlayerCachedDataDict = {};\r\n        for (let i = 0; i < playerIdStrList.length; ++i) {\r\n          const k = playerIdStrList[i];\r\n          const playerId = parseInt(k);\r\n          if (playerId == self.selfPlayerInfo.id) {\r\n            const immediateSelfPlayerInfo = players[k];\r\n            Object.assign(self.selfPlayerInfo, {\r\n              x: immediateSelfPlayerInfo.x,\r\n              y: immediateSelfPlayerInfo.y,\r\n              speed: immediateSelfPlayerInfo.speed,\r\n              battleState: immediateSelfPlayerInfo.battleState,\r\n              score: immediateSelfPlayerInfo.score,\r\n            });\r\n            continue;\r\n          }\r\n          const anotherPlayer = players[k];\r\n          // Note that this callback is invoked in the NetworkThread, and the rendering should be executed in the GUIThread, e.g. within `update(dt)`.\r\n          self.otherPlayerCachedDataDict[playerId] = anotherPlayer;\r\n        }\r\n        self.treasureInfoDict = {};\r\n        const treasures = roomDownsyncFrame.treasures;\r\n        const treasuresLocalIdStrList = Object.keys(treasures);\r\n        for (let i = 0; i < treasuresLocalIdStrList.length; ++i) {\r\n          const k = treasuresLocalIdStrList[i];\r\n          const treasureLocalIdInBattle = parseInt(k);\r\n          const treasureInfo = treasures[k];\r\n          self.treasureInfoDict[treasureLocalIdInBattle] = treasureInfo;\r\n        }\r\n\r\n        self.trapInfoDict = {};\r\n        const traps = roomDownsyncFrame.traps;\r\n        const trapsLocalIdStrList = Object.keys(traps);\r\n        for (let i = 0; i < trapsLocalIdStrList.length; ++i) {\r\n          const k = trapsLocalIdStrList[i];\r\n          const trapLocalIdInBattle = parseInt(k);\r\n          const trapInfo = traps[k];\r\n          self.trapInfoDict[trapLocalIdInBattle] = trapInfo;\r\n        }\r\n\r\n        self.trapBulletInfoDict = {};\r\n        const bullets = roomDownsyncFrame.bullets;\r\n        const bulletsLocalIdStrList = Object.keys(bullets);\r\n        for (let i = 0; i < bulletsLocalIdStrList.length; ++i) {\r\n          const k = bulletsLocalIdStrList[i];\r\n          const bulletLocalIdInBattle = parseInt(k);\r\n          const bulletInfo = bullets[k];\r\n          self.trapBulletInfoDict[bulletLocalIdInBattle] = bulletInfo;\r\n        }\r\n\r\n        if (0 == self.lastRoomDownsyncFrameId) {\r\n          self.battleState = ALL_BATTLE_STATES.IN_BATTLE;\r\n          if (1 == frameId) {\r\n            // No need to prompt upon rejoined.\r\n            self.popupSimplePressToGo(\"Battle started!\");\r\n          }\r\n          self.onBattleStarted();\r\n        }\r\n        self.lastRoomDownsyncFrameId = frameId;\r\n        // TODO: Inject a NetworkDoctor as introduced in https://app.yinxiang.com/shard/s61/nl/13267014/5c575124-01db-419b-9c02-ec81f78c6ddc/.\r\n      };\r\n      if(ALL_BATTLE_STATES.WAITING == self.battleState) {\r\n        self.showPopopInCanvas(self.findingPlayerNode);\r\n      }\r\n    }\r\n  },\r\n\r\n  setupInputControls() {\r\n    const instance = this;\r\n    const mapNode = instance.node;\r\n    const canvasNode = mapNode.parent;\r\n    const joystickInputControllerScriptIns = canvasNode.getComponent(\"TouchEventsManager\");\r\n    const inputControlPollerMillis = (1000 / joystickInputControllerScriptIns.pollerFps);\r\n\r\n    const ctrl = joystickInputControllerScriptIns;\r\n    instance.ctrl = ctrl;\r\n\r\n    instance.inputControlTimer = setInterval(function() {\r\n      if (false == instance._inputControlEnabled) return;\r\n      instance.selfPlayerScriptIns.activeDirection = ctrl.activeDirection;\r\n    }, inputControlPollerMillis);\r\n  },\r\n\r\n  enableInputControls() {\r\n    this._inputControlEnabled = true;\r\n  },\r\n\r\n  disableInputControls() {\r\n    this._inputControlEnabled = false;\r\n  },\r\n\r\n  onBattleStarted() {\r\n    const self = this;\r\n    const canvasNode = self.canvasNode;\r\n    self.spawnSelfPlayer();\r\n    self.upsyncLoopInterval = setInterval(self._onPerUpsyncFrame.bind(self), self.clientUpsyncFps);\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    self.enableInputControls();\r\n    if(self.findingPlayerNode.parent) {\r\n      self.findingPlayerNode.parent.removeChild(self.findingPlayerNode);\r\n    }\r\n  },\r\n\r\n  onBattleStopped(players) {\r\n    const self = this;\r\n    const canvasNode = self.canvasNode;\r\n    const resultPanelNode = self.resultPanelNode;\r\n    const resultPanelScriptIns =  resultPanelNode.getComponent(\"ResultPanel\");\r\n    resultPanelScriptIns.showPlayerInfo(players);\r\n    // Such that it doesn't execute \"update(dt)\" anymore. \r\n    self.selfPlayerNode.active = false;\r\n    self.battleState = ALL_BATTLE_STATES.IN_SETTLEMENT;\r\n    self.showPopopInCanvas(resultPanelNode);\r\n  },\r\n\r\n  spawnSelfPlayer() {\r\n    const instance = this;\r\n    const newPlayerNode = cc.instantiate(instance.selfPlayerPrefab);\r\n    const tiledMapIns = instance.node.getComponent(cc.TiledMap);\r\n    let toStartWithPos = cc.v2(instance.selfPlayerInfo.x, instance.selfPlayerInfo.y)\r\n    newPlayerNode.setPosition(toStartWithPos);\r\n    newPlayerNode.getComponent(\"SelfPlayer\").mapNode = instance.node;\r\n\r\n    instance.node.addChild(newPlayerNode);\r\n\r\n    setLocalZOrder(newPlayerNode, 5);\r\n    instance.selfPlayerNode = newPlayerNode;\r\n    instance.selfPlayerScriptIns = newPlayerNode.getComponent(\"SelfPlayer\");\r\n  },\r\n\r\n  update(dt) {\r\n    const self = this;\r\n    const mapNode = self.node;\r\n    const canvasNode = mapNode.parent;\r\n    const canvasParentNode = canvasNode.parent;\r\n    if (null != window.boundRoomId) {\r\n      self.boundRoomIdLabel.string = window.boundRoomId;\r\n    }\r\n    if (null != self.selfPlayerInfo) {\r\n      self.selfPlayerIdLabel.string = self.selfPlayerInfo.id;\r\n      const score  = self.selfPlayerInfo.score ? self.selfPlayerInfo.score : 0 \r\n      self.selfPlayerScoreLabel.string = score;\r\n      if (null != self.selfPlayerScriptIns) {\r\n        self.selfPlayerScriptIns.updateSpeed(self.selfPlayerInfo.speed);\r\n      }\r\n    }\r\n\r\n    let toRemovePlayerNodeDict = {};\r\n    Object.assign(toRemovePlayerNodeDict, self.otherPlayerNodeDict);\r\n\r\n    let toRemoveTreasureNodeDict = {};\r\n    Object.assign(toRemoveTreasureNodeDict, self.treasureNodeDict);\r\n\r\n    let toRemoveTrapNodeDict = {};\r\n    Object.assign(toRemoveTrapNodeDict, self.trapNodeDict);\r\n\r\n    let toRemoveBulletNodeDict = {};\r\n    Object.assign(toRemoveBulletNodeDict, self.trapBulletNodeDict);\r\n\r\n    for (let k in self.otherPlayerCachedDataDict) {\r\n      const playerId = parseInt(k);\r\n      const cachedPlayerData = self.otherPlayerCachedDataDict[playerId];\r\n      const newPos = cc.v2(\r\n        cachedPlayerData.x,\r\n        cachedPlayerData.y\r\n      );\r\n     //\r\n     if(!self.scoreInfoDict[playerId]){\r\n        const scoreNode = cc.instantiate(self.otherPlayerScoreIndicatorPrefab);  \r\n        const debugInfoNode = canvasParentNode.getChildByName(\"DebugInfo\");\r\n        scoreNode.getChildByName(\"title\").getComponent(cc.Label).string = \"player\"+cachedPlayerData.id+\"'s score:\";\r\n        safelyAddChild(debugInfoNode,scoreNode);\r\n        self.scoreInfoDict[playerId] = scoreNode;\r\n      }\r\n      const playerScore  = !cachedPlayerData.score ? cachedPlayerData.score  : 0 \r\n      self.scoreInfoDict[playerId].getChildByName(\"OtherPlayerScoreLabel\").getComponent(cc.Label).string = playerScore;\r\n      let targetNode = self.otherPlayerNodeDict[playerId];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.selfPlayerPrefab);\r\n        targetNode.getComponent(\"SelfPlayer\").mapNode = mapNode;\r\n        self.otherPlayerNodeDict[playerId] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }\r\n      const aControlledOtherPlayerScriptIns = targetNode.getComponent(\"SelfPlayer\"); \r\n      aControlledOtherPlayerScriptIns.updateSpeed(cachedPlayerData.speed);\r\n\r\n      if (null != toRemovePlayerNodeDict[playerId]) {\r\n        delete toRemovePlayerNodeDict[playerId];\r\n      }\r\n      if (0 != cachedPlayerData.dir.dx || 0 != cachedPlayerData.dir.dy) {\r\n        const newScheduledDirection = self.ctrl.discretizeDirection(cachedPlayerData.dir.dx, cachedPlayerData.dir.dy, self.ctrl.joyStickEps);\r\n        targetNode.getComponent(\"SelfPlayer\").scheduleNewDirection(newScheduledDirection, false /* DON'T interrupt playing anim. */ );\r\n      }\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y\r\n      );\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const toMoveByVecMag = toMoveByVec.mag();\r\n      const toTeleportDisThreshold = (cachedPlayerData.speed * dt * 100);\r\n      const notToMoveDisThreshold = (cachedPlayerData.speed * dt * 0.5);\r\n      if (toMoveByVecMag < notToMoveDisThreshold) {\r\n        targetNode.getComponent(\"SelfPlayer\").activeDirection = {\r\n          dx: 0,\r\n          dy: 0\r\n        };\r\n      } else {\r\n        if (toMoveByVecMag >= toTeleportDisThreshold) {\r\n          cc.log(`Player ${cachedPlayerData.id} is teleporting! Having toMoveByVecMag == ${toMoveByVecMag}, toTeleportDisThreshold == ${toTeleportDisThreshold}`);\r\n          targetNode.getComponent(\"SelfPlayer\").activeDirection = {\r\n            dx: 0,\r\n            dy: 0\r\n          };\r\n          // TODO: Use `cc.Action`?\r\n          targetNode.setPosition(newPos);\r\n        } else {\r\n          // The common case which is suitable for interpolation.\r\n          const normalizedDir = {\r\n            dx: toMoveByVec.x / toMoveByVecMag,\r\n            dy: toMoveByVec.y / toMoveByVecMag,\r\n          };\r\n          targetNode.getComponent(\"SelfPlayer\").activeDirection = normalizedDir;\r\n        }\r\n      }\r\n    }\r\n\r\n   //  \r\n    for (let k in self.trapInfoDict) {\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      const trapInfo = self.trapInfoDict[trapLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        trapInfo.x,\r\n        trapInfo.y\r\n      );\r\n      let targetNode = self.trapNodeDict[trapLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.trapPrefab);\r\n        self.trapNodeDict[trapLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n        /*\r\n        //trap\r\n        const pickupBoundary = trapInfo.pickupBoundary;\r\n        const anchor = pickupBoundary.anchor; \r\n        const newColliderIns = targetNode.getComponent(cc.PolygonCollider);\r\n        newColliderIns.points = [];\r\n        for (let point of pickupBoundary.points) {\r\n          const p = cc.v2(parseFloat(point.x), parseFloat(point.y));\r\n          newColliderIns.points.push(p);\r\n        }\r\n        */\r\n      }\r\n      if (null != toRemoveTrapNodeDict[trapLocalIdInBattle]) {\r\n        delete toRemoveTrapNodeDict[trapLocalIdInBattle];\r\n      }\r\n      \r\n    }\r\n\r\n   // bullet \r\n    for (let k in self.trapBulletInfoDict) {\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      const bulletInfo = self.trapBulletInfoDict[bulletLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        bulletInfo.x,\r\n        bulletInfo.y\r\n      );\r\n      let targetNode = self.trapBulletNodeDict[bulletLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.trapBulletPrefab);\r\n        self.trapBulletNodeDict[bulletLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n      }else {\r\n        targetNode.setPosition(newPos);\r\n      }\r\n      if (null != toRemoveBulletNodeDict[bulletLocalIdInBattle]) {\r\n        delete toRemoveBulletNodeDict[bulletLocalIdInBattle];\r\n      }\r\n\r\n      if (0 < targetNode.getNumberOfRunningActions()) {\r\n        // A significant trick to smooth the position sync performance!\r\n        continue;\r\n      }\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y\r\n      );\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const durationSeconds = dt; // Using `dt` temporarily!\r\n      targetNode.runAction(cc.moveTo(durationSeconds, newPos));\r\n    }\r\n\r\n   //  \r\n    for (let k in self.treasureInfoDict) {\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      const treasureInfo = self.treasureInfoDict[treasureLocalIdInBattle];\r\n      const newPos = cc.v2(\r\n        treasureInfo.x,\r\n        treasureInfo.y\r\n      );\r\n      let targetNode = self.treasureNodeDict[treasureLocalIdInBattle];\r\n      if (!targetNode) {\r\n        targetNode = cc.instantiate(self.treasurePrefab);\r\n        self.treasureNodeDict[treasureLocalIdInBattle] = targetNode;\r\n        safelyAddChild(mapNode, targetNode);\r\n        targetNode.setPosition(newPos);\r\n        setLocalZOrder(targetNode, 5);\r\n        \r\n        /* \r\n        //treasure\r\n        const pickupBoundary = treasureInfo.pickupBoundary;\r\n        const anchor = pickupBoundary.anchor; \r\n        const newColliderIns = targetNode.getComponent(cc.PolygonCollider);\r\n        newColliderIns.points = [];\r\n        for (let point of pickupBoundary.points) {\r\n          const p = cc.v2(parseFloat(point.x), parseFloat(point.y));\r\n          newColliderIns.points.push(p);\r\n        }\r\n        */\r\n      }\r\n\r\n      if (null != toRemoveTreasureNodeDict[treasureLocalIdInBattle]) {\r\n        delete toRemoveTreasureNodeDict[treasureLocalIdInBattle];\r\n      }\r\n      if (0 < targetNode.getNumberOfRunningActions()) {\r\n        // A significant trick to smooth the position sync performance!\r\n        continue;\r\n      }\r\n      const oldPos = cc.v2(\r\n        targetNode.x,\r\n        targetNode.y\r\n      );\r\n      const toMoveByVec = newPos.sub(oldPos);\r\n      const durationSeconds = dt; // Using `dt` temporarily!\r\n      targetNode.runAction(cc.moveTo(durationSeconds, newPos));\r\n    }\r\n\r\n    // Coping with removed players.\r\n    for (let k in toRemovePlayerNodeDict) {\r\n      const playerId = parseInt(k);\r\n      toRemovePlayerNodeDict[k].parent.removeChild(toRemovePlayerNodeDict[k]);\r\n      delete self.otherPlayerNodeDict[playerId];\r\n    }\r\n\r\n    // Coping with removed treasures.\r\n    for (let k in toRemoveTreasureNodeDict) {\r\n      const treasureLocalIdInBattle = parseInt(k);\r\n      toRemoveTreasureNodeDict[k].parent.removeChild(toRemoveTreasureNodeDict[k]);\r\n      delete self.treasureNodeDict[treasureLocalIdInBattle];\r\n    }\r\n\r\n    // Coping with removed traps.\r\n    for (let k in toRemoveTrapNodeDict) {\r\n      const trapLocalIdInBattle = parseInt(k);\r\n      toRemoveTrapNodeDict[k].parent.removeChild(toRemoveTrapNodeDict[k]);\r\n      delete self.trapNodeDict[trapLocalIdInBattle];\r\n    }\r\n\r\n    // Coping with removed bullets.\r\n    for (let k in toRemoveBulletNodeDict) {\r\n      const bulletLocalIdInBattle = parseInt(k);\r\n      toRemoveBulletNodeDict[k].parent.removeChild(toRemoveBulletNodeDict[k]);\r\n      delete self.trapBulletNodeDict[bulletLocalIdInBattle];\r\n    }\r\n  },\r\n\r\n  transitToState(s) {\r\n    const self = this;\r\n    self.state = s;\r\n  },\r\n\r\n  logout(byClick /* The case where this param is \"true\" will be triggered within `ConfirmLogout.js`.*/ , shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n    const localClearance = function() {\r\n      if (byClick) {\r\n        /**\r\n        * WARNING: We MUST distinguish `byClick`, otherwise the `window.clientSession.onclose(event)` could be confused by local events!\r\n        */\r\n        window.closeWSConnection();\r\n      }\r\n      if (true != shouldRetainBoundRoomIdInBothVolatileAndPersistentStorage) {\r\n        window.clearBoundRoomIdInBothVolatileAndPersistentStorage();\r\n      }\r\n      cc.sys.localStorage.removeItem('selfPlayer');\r\n      cc.director.loadScene('login');\r\n    };\r\n\r\n    const self = this;\r\n    if (null != cc.sys.localStorage.selfPlayer) {\r\n      const selfPlayer = JSON.parse(cc.sys.localStorage.selfPlayer);\r\n      const requestContent = {\r\n        intAuthToken: selfPlayer.intAuthToken\r\n      }\r\n      try {\r\n        NetworkUtils.ajax({\r\n          url: backendAddress.PROTOCOL + '://' + backendAddress.HOST + ':' + backendAddress.PORT + constants.ROUTE_PATH.API + constants.ROUTE_PATH.PLAYER + constants.ROUTE_PATH.VERSION + constants.ROUTE_PATH.INT_AUTH_TOKEN + constants.ROUTE_PATH.LOGOUT,\r\n          type: \"POST\",\r\n          data: requestContent,\r\n          success: function(res) {\r\n            if (res.ret != constants.RET_CODE.OK) {\r\n              cc.log(`Logout failed: ${res}.`);\r\n            }\r\n            localClearance();\r\n          },\r\n          error: function(xhr, status, errMsg) {\r\n            localClearance();\r\n          },\r\n          timeout: function() {\r\n            localClearance();\r\n          }\r\n        });\r\n      } catch (e) {} finally {\r\n        // For Safari (both desktop and mobile).\r\n        localClearance();\r\n      }\r\n    } else {\r\n      localClearance();\r\n    }\r\n  },\r\n\r\n  onLogoutClicked(evt) {\r\n    const self = this;\r\n    self.showPopopInCanvas(self.confirmLogoutNode);\r\n  },\r\n\r\n  onLogoutConfirmationDismissed() {\r\n    const self = this;\r\n    self.transitToState(ALL_MAP_STATES.VISUAL);\r\n    const canvasNode = self.canvasNode;\r\n    canvasNode.removeChild(self.confirmLogoutNode);\r\n    self.enableInputControls();\r\n  },\r\n  \r\n  initWSConnection(evt, cb) {\r\n    const self = this;\r\n    if(cb){ \r\n      cb()\r\n    } \r\n    initPersistentSessionClient(self.initAfterWSConncted);\r\n  },\r\n\r\n  showPopopInCanvas(toShowNode) {\r\n    const self = this;\r\n    self.disableInputControls();\r\n    self.transitToState(ALL_MAP_STATES.SHOWING_MODAL_POPUP);\r\n    safelyAddChild(self.widgetsAboveAllNode, toShowNode);\r\n    setLocalZOrder(toShowNode, 10);\r\n  },\r\n\r\n});\r\n"]}